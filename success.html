<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thank You! - Fujisan.AI</title>
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-WG9LDKZG');</script>
    <!-- End Google Tag Manager -->
    
    <!-- Google Ads Conversion Tracking -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-CONVERSION_ID"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'AW-CONVERSION_ID');
    </script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .success-card {
            background: white;
            border-radius: 24px;
            padding: 48px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            animation: scaleIn 0.5s ease-out;
        }
        
        @keyframes scaleIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .success-icon svg {
            width: 40px;
            height: 40px;
            color: white;
        }
        
        h1 {
            font-size: 28px;
            color: #1f2937;
            margin-bottom: 12px;
        }
        
        .subtitle {
            font-size: 16px;
            color: #6b7280;
            margin-bottom: 32px;
            line-height: 1.6;
        }
        
        .plan-info {
            background: #f3f4f6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 32px;
        }
        
        .plan-name {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .plan-value {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
        }
        
        .next-steps {
            text-align: left;
            margin-bottom: 32px;
        }
        
        .next-steps h3 {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .step-number {
            width: 24px;
            height: 24px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .step-text {
            font-size: 14px;
            color: #374151;
            line-height: 1.5;
        }
        
        .btn-primary {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .help-text {
            margin-top: 24px;
            font-size: 13px;
            color: #9ca3af;
        }
        
        .help-text a {
            color: #667eea;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WG9LDKZG"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div class="success-card">
        <div class="success-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
        </div>
        
        <h1 id="title">Payment Successful!</h1>
        <p class="subtitle" id="subtitle">
            Welcome to Fujisan.AI! Your subscription is now active and you have full access to all features.
        </p>
        
        <div class="plan-info">
            <div class="plan-name" id="planLabel">Your Plan</div>
            <div class="plan-value" id="planName">Pro Annual</div>
        </div>
        
        <div class="next-steps">
            <h3 id="nextStepsTitle">Next Steps</h3>
            <div class="step">
                <span class="step-number">1</span>
                <span class="step-text" id="step1">Check your email for login instructions</span>
            </div>
            <div class="step">
                <span class="step-number">2</span>
                <span class="step-text" id="step2">Take the Quick Check to identify your weak points</span>
            </div>
            <div class="step">
                <span class="step-number">3</span>
                <span class="step-text" id="step3">Start your personalized study plan</span>
            </div>
        </div>
        
        <a href="https://app.fujisan.ai" class="btn-primary" id="ctaBtn">Start Learning Now â†’</a>
        
        <p class="help-text">
            Questions? Contact us at <a href="mailto:support@fujisan.ai">support@fujisan.ai</a>
        </p>
    </div>

    <script>
        // =============================================
        // FIREBASE INITIALIZATION
        // =============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
            authDomain: "fujisan-ai.firebaseapp.com",
            databaseURL: "https://fujisan-ai-default-rtdb.firebaseio.com",
            projectId: "fujisan-ai",
            storageBucket: "fujisan-ai.appspot.com",
            messagingSenderId: "xxxxxxxxxxxx",
            appId: "1:xxxxxxxxxxxx:web:xxxxxxxxxxxx"
        };
        
        // Initialize Firebase (loaded via CDN)
        if (typeof firebase !== 'undefined' && !firebase.apps?.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        // =============================================
        // CONVERSION TRACKING
        // =============================================
        
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session_id');
        const plan = urlParams.get('plan') || 'pro';
        const billing = urlParams.get('billing') || 'annual';
        const userId = urlParams.get('uid'); // User ID passed from checkout
        const referrerId = urlParams.get('ref'); // Referrer ID if came from referral
        
        // Plan pricing (must match Stripe)
        const planPricing = {
            basic: { monthly: 4.99, annual: 47.88 },
            pro: { monthly: 9.99, annual: 95.88 },
            ultimate: { monthly: 19.99, annual: 191.88 }
        };
        
        // Get conversion value
        const conversionValue = planPricing[plan]?.[billing] || 95.88;
        
        // =============================================
        // FIRE CONVERSION EVENTS
        // =============================================
        
        // 1. DataLayer push for GTM
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({
            'event': 'purchase',
            'ecommerce': {
                'transaction_id': sessionId || 'txn_' + Date.now(),
                'value': conversionValue,
                'currency': 'USD',
                'items': [{
                    'item_id': plan + '_' + billing,
                    'item_name': 'Fujisan.AI ' + plan.charAt(0).toUpperCase() + plan.slice(1) + ' ' + billing.charAt(0).toUpperCase() + billing.slice(1),
                    'price': conversionValue,
                    'quantity': 1
                }]
            }
        });
        
        // 2. Google Ads Conversion (direct gtag)
        // Replace AW-CONVERSION_ID/CONVERSION_LABEL with your actual values
        gtag('event', 'conversion', {
            'send_to': 'AW-CONVERSION_ID/PURCHASE_LABEL',
            'value': conversionValue,
            'currency': 'USD',
            'transaction_id': sessionId || 'txn_' + Date.now()
        });
        
        // 3. Console log for debugging
        console.log('Conversion tracked:', {
            plan: plan,
            billing: billing,
            value: conversionValue,
            sessionId: sessionId,
            userId: userId,
            referrerId: referrerId
        });
        
        // =============================================
        // REFERRAL TRACKING
        // =============================================
        
        async function updateReferralStatus() {
            if (!userId || !referrerId || typeof firebase === 'undefined') {
                console.log('Referral tracking skipped:', { userId, referrerId });
                return;
            }
            
            try {
                const db = firebase.database();
                
                // Update referral status to 'paid'
                await db.ref(`referrals/${referrerId}/${userId}`).update({
                    status: 'paid',
                    paidDate: new Date().toISOString(),
                    plan: plan,
                    billing: billing,
                    amount: conversionValue
                });
                
                // Update user's subscription info (with trial)
                const trialEndDate = new Date();
                trialEndDate.setDate(trialEndDate.getDate() + 7); // 7-day trial
                
                await db.ref(`users/${userId}/subscription`).set({
                    status: 'trialing',
                    plan: plan,
                    billing: billing,
                    startDate: new Date().toISOString(),
                    trialEndDate: trialEndDate.toISOString(),
                    sessionId: sessionId
                });
                
                console.log('Referral status updated: paid');
                
                // Show referral thank you message
                showReferralThankYou();
                
            } catch (error) {
                console.error('Failed to update referral status:', error);
            }
        }
        
        function showReferralThankYou() {
            const subtitle = document.getElementById('subtitle');
            if (subtitle && referrerId) {
                const originalText = subtitle.textContent;
                subtitle.innerHTML = originalText + '<br><br>ğŸ <strong>Your friend will receive 1 month FREE in 30 days!</strong>';
            }
        }
        
        // Run referral update
        if (typeof firebase !== 'undefined') {
            // Wait for Firebase to be ready
            document.addEventListener('DOMContentLoaded', updateReferralStatus);
        }
        
        // =============================================
        // UPDATE UI BASED ON PLAN
        // =============================================
        
        const planNames = {
            basic: { monthly: 'Basic Monthly', annual: 'Basic Annual' },
            pro: { monthly: 'Pro Monthly', annual: 'Pro Annual' },
            ultimate: { monthly: 'Ultimate Monthly', annual: 'Ultimate Annual' }
        };
        
        const planDisplay = planNames[plan]?.[billing] || 'Pro Annual';
        document.getElementById('planName').textContent = planDisplay + ' - $' + conversionValue;
        
        // =============================================
        // MULTI-LANGUAGE SUPPORT
        // =============================================
        
        const translations = {
            en: {
                title: 'Welcome to Fujisan.AI!',
                subtitle: 'Your 7-day free trial has started! You have full access to all features. Your card will be charged after the trial ends.',
                planLabel: 'Your Plan',
                nextStepsTitle: 'Next Steps',
                step1: 'Check your email for confirmation',
                step2: 'Take the Quick Check to identify your weak points',
                step3: 'Start your personalized study plan',
                ctaBtn: 'Start Learning Now â†’'
            },
            ja: {
                title: 'Fujisan.AIã¸ã‚ˆã†ã“ãï¼',
                subtitle: '7æ—¥é–“ã®ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ãŒé–‹å§‹ã—ã¾ã—ãŸï¼ã™ã¹ã¦ã®æ©Ÿèƒ½ã‚’ãŠè©¦ã—ã„ãŸã ã‘ã¾ã™ã€‚ãƒˆãƒ©ã‚¤ã‚¢ãƒ«çµ‚äº†å¾Œã«èª²é‡‘ãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚',
                planLabel: 'ã”å¥‘ç´„ãƒ—ãƒ©ãƒ³',
                nextStepsTitle: 'æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—',
                step1: 'ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯',
                step2: 'ã‚¯ã‚¤ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯ã§å¼±ç‚¹ã‚’æŠŠæ¡',
                step3: 'ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸå­¦ç¿’ã‚’é–‹å§‹',
                ctaBtn: 'å­¦ç¿’ã‚’å§‹ã‚ã‚‹ â†’'
            },
            ko: {
                title: 'ê²°ì œ ì™„ë£Œ!',
                subtitle: 'Fujisan.AIì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! êµ¬ë…ì´ í™œì„±í™”ë˜ì–´ ëª¨ë“  ê¸°ëŠ¥ì„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
                planLabel: 'ì„ íƒ í”Œëœ',
                nextStepsTitle: 'ë‹¤ìŒ ë‹¨ê³„',
                step1: 'ì´ë©”ì¼ì—ì„œ ë¡œê·¸ì¸ ì•ˆë‚´ í™•ì¸',
                step2: 'ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ë¡œ ì•½ì  íŒŒì•…',
                step3: 'ë§ì¶¤ í•™ìŠµ ê³„íš ì‹œì‘',
                ctaBtn: 'í•™ìŠµ ì‹œì‘í•˜ê¸° â†’'
            },
            'zh-tw': {
                title: 'ä»˜æ¬¾æˆåŠŸï¼',
                subtitle: 'æ­¡è¿ä½¿ç”¨ Fujisan.AIï¼æ‚¨çš„è¨‚é–±å·²å•Ÿç”¨ï¼Œå¯ä»¥ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½ã€‚',
                planLabel: 'æ‚¨çš„æ–¹æ¡ˆ',
                nextStepsTitle: 'ä¸‹ä¸€æ­¥',
                step1: 'æŸ¥çœ‹é›»å­éƒµä»¶ä¸­çš„ç™»å…¥èªªæ˜',
                step2: 'é€²è¡Œå¿«é€Ÿæ¸¬è©¦ä»¥ç¢ºå®šå¼±é»',
                step3: 'é–‹å§‹å€‹äººåŒ–å­¸ç¿’è¨ˆåŠƒ',
                ctaBtn: 'é–‹å§‹å­¸ç¿’ â†’'
            },
            'zh-cn': {
                title: 'ä»˜æ¬¾æˆåŠŸï¼',
                subtitle: 'æ¬¢è¿ä½¿ç”¨ Fujisan.AIï¼æ‚¨çš„è®¢é˜…å·²æ¿€æ´»ï¼Œå¯ä»¥ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½ã€‚',
                planLabel: 'æ‚¨çš„æ–¹æ¡ˆ',
                nextStepsTitle: 'ä¸‹ä¸€æ­¥',
                step1: 'æŸ¥çœ‹é‚®ä»¶ä¸­çš„ç™»å½•è¯´æ˜',
                step2: 'è¿›è¡Œå¿«é€Ÿæµ‹è¯•ä»¥ç¡®å®šå¼±ç‚¹',
                step3: 'å¼€å§‹ä¸ªæ€§åŒ–å­¦ä¹ è®¡åˆ’',
                ctaBtn: 'å¼€å§‹å­¦ä¹  â†’'
            },
            vi: {
                title: 'Thanh toÃ¡n thÃ nh cÃ´ng!',
                subtitle: 'ChÃ o má»«ng Ä‘áº¿n Fujisan.AI! ÄÄƒng kÃ½ cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c kÃ­ch hoáº¡t vÃ  báº¡n cÃ³ quyá»n truy cáº­p Ä‘áº§y Ä‘á»§.',
                planLabel: 'GÃ³i cá»§a báº¡n',
                nextStepsTitle: 'BÆ°á»›c tiáº¿p theo',
                step1: 'Kiá»ƒm tra email Ä‘á»ƒ biáº¿t hÆ°á»›ng dáº«n Ä‘Äƒng nháº­p',
                step2: 'LÃ m bÃ i kiá»ƒm tra nhanh Ä‘á»ƒ xÃ¡c Ä‘á»‹nh Ä‘iá»ƒm yáº¿u',
                step3: 'Báº¯t Ä‘áº§u káº¿ hoáº¡ch há»c táº­p cÃ¡ nhÃ¢n hÃ³a',
                ctaBtn: 'Báº¯t Ä‘áº§u há»c ngay â†’'
            },
            id: {
                title: 'Pembayaran Berhasil!',
                subtitle: 'Selamat datang di Fujisan.AI! Langganan Anda sudah aktif dan Anda memiliki akses penuh.',
                planLabel: 'Paket Anda',
                nextStepsTitle: 'Langkah Selanjutnya',
                step1: 'Cek email untuk instruksi login',
                step2: 'Ikuti Tes Cepat untuk identifikasi kelemahan',
                step3: 'Mulai rencana belajar personal',
                ctaBtn: 'Mulai Belajar â†’'
            }
        };
        
        // Detect language from URL or browser
        const langParam = urlParams.get('lang');
        const browserLang = navigator.language.split('-')[0];
        const lang = langParam || (translations[browserLang] ? browserLang : 'en');
        
        // Apply translations
        const t = translations[lang] || translations.en;
        document.getElementById('title').textContent = t.title;
        document.getElementById('subtitle').textContent = t.subtitle;
        document.getElementById('planLabel').textContent = t.planLabel;
        document.getElementById('nextStepsTitle').textContent = t.nextStepsTitle;
        document.getElementById('step1').textContent = t.step1;
        document.getElementById('step2').textContent = t.step2;
        document.getElementById('step3').textContent = t.step3;
        document.getElementById('ctaBtn').textContent = t.ctaBtn;
        
        // Set HTML lang attribute
        document.documentElement.lang = lang;
    </script>
</body>
</html>
