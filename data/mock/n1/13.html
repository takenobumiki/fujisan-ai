<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>JLPT N1-13 æ¨¡æ“¬ãƒ†ã‚¹ãƒˆ</title>
<style>
:root {
  --primary: #007aff;
  --primary-dark: #0056b3;
  --primary-light: #e5f2ff;
  --bg-gradient: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
  --header-gradient: linear-gradient(135deg, #1565c0 0%, #42a5f5 100%);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Yu Gothic', sans-serif;
  background: var(--bg-gradient);
  min-height: 100vh;
  padding: 16px;
  -webkit-font-smoothing: antialiased;
}
.container {
  max-width: 680px;
  margin: 0 auto;
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  overflow: hidden;
}
.header {
  background: var(--header-gradient);
  color: #fff;
  padding: 24px 20px;
  text-align: center;
}
.header h1 {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 4px;
}
.header .subtitle { font-size: 0.85rem; opacity: 0.85; }
.home-content { padding: 24px; }
.stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 24px;
}
.stat-card {
  background: var(--header-gradient);
  color: #fff;
  padding: 20px 12px;
  border-radius: 16px;
  text-align: center;
}
.stat-value { font-size: 2rem; font-weight: 700; line-height: 1.2; }
.stat-label { font-size: 0.75rem; opacity: 0.9; margin-top: 4px; }
.home-actions { display: flex; flex-direction: column; gap: 12px; align-items: center; }
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 14px 28px;
  border: none;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}
.btn:active { transform: scale(0.98); }
.btn-primary { background: var(--primary); color: #fff; font-size: 1.1rem; padding: 18px 48px; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-secondary { background: #f0f0f5; color: #333; }
.btn-secondary:hover { background: #e0e0e5; }
.btn-danger { background: #ff3b30; color: #fff; }
.btn-row { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
.test-header { background: var(--header-gradient); color: #fff; padding: 16px 20px; }
.test-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.test-title { font-size: 1rem; font-weight: 600; }
.timer { font-size: 1.5rem; font-weight: 700; font-variant-numeric: tabular-nums; }
.timer.warning { color: #ffcc00; }
.timer.danger { color: #ff3b30; animation: blink 1s infinite; }
@keyframes blink { 50% { opacity: 0.6; } }
.progress-container { display: flex; align-items: center; gap: 12px; }
.progress-bar { flex: 1; height: 6px; background: rgba(255,255,255,0.3); border-radius: 3px; overflow: hidden; }
.progress-fill { height: 100%; background: #fff; transition: width 0.3s ease; }
.progress-text { font-size: 0.85rem; font-weight: 500; white-space: nowrap; }
.question-container { padding: 20px; }
.section-badge {
  display: inline-block;
  background: var(--primary-light);
  color: var(--primary-dark);
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
  margin-bottom: 16px;
}
.question-text {
  font-size: 1.05rem;
  line-height: 1.8;
  color: #1a1a1a;
  margin-bottom: 20px;
  padding: 16px;
  background: #f8f9fa;
  border-radius: 12px;
  border-left: 4px solid var(--primary);
}
.question-text u { text-decoration: none; background: var(--primary-light); padding: 2px 4px; border-radius: 4px; font-weight: 600; }
.options { display: flex; flex-direction: column; gap: 10px; }
.option {
  display: flex;
  align-items: center;
  padding: 14px 16px;
  background: #fff;
  border: 2px solid #e5e5ea;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.15s ease;
}
.option:hover { border-color: var(--primary); background: var(--primary-light); }
.option.selected { border-color: var(--primary); background: var(--primary-light); }
.option-marker {
  width: 28px;
  height: 28px;
  border: 2px solid #d1d1d6;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  color: #666;
  margin-right: 12px;
  flex-shrink: 0;
  font-size: 0.9rem;
}
.option.selected .option-marker { border-color: var(--primary); background: var(--primary); color: #fff; }
.option-text { font-size: 0.95rem; color: #333; }
.test-nav { display: flex; justify-content: space-between; padding: 16px 20px; border-top: 1px solid #eee; }
.nav-btn {
  padding: 12px 24px;
  border: none;
  border-radius: 10px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
}
.nav-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.nav-btn.prev { background: #f0f0f5; color: #333; }
.nav-btn.next { background: var(--primary); color: #fff; }
.nav-btn.submit { background: #34c759; color: #fff; }
.results-content { padding: 24px; text-align: center; }
.score-circle {
  width: 180px;
  height: 180px;
  border-radius: 50%;
  background: var(--header-gradient);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  margin: 0 auto 16px;
  color: #fff;
}
.score-value { font-size: 3.5rem; font-weight: 800; line-height: 1; }
.score-detail { font-size: 0.9rem; opacity: 0.9; margin-top: 4px; }
.pass-badge {
  display: inline-block;
  padding: 10px 24px;
  border-radius: 25px;
  font-weight: 700;
  font-size: 1.1rem;
  margin-bottom: 20px;
}
.pass-badge.pass { background: #d4edda; color: #155724; }
.pass-badge.fail { background: #f8d7da; color: #721c24; }
.section-scores {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  gap: 10px;
  margin-bottom: 24px;
}
.section-score-card {
  background: #f8f9fa;
  padding: 12px;
  border-radius: 10px;
}
.section-score-value { font-size: 1.3rem; font-weight: 700; color: var(--primary); }
.section-score-label { font-size: 0.75rem; color: #666; }
.answer-list { margin-top: 20px; text-align: left; }
.answer-list.hidden { display: none; }
.answer-item {
  padding: 14px;
  background: #f8f9fa;
  border-radius: 10px;
  margin-bottom: 10px;
  border-left: 4px solid #34c759;
}
.answer-item.wrong { border-left-color: #ff3b30; background: #fff5f5; }
.answer-q-num { font-size: 0.8rem; color: #666; margin-bottom: 4px; }
.answer-q-text { font-size: 0.9rem; color: #333; margin-bottom: 8px; }
.answer-result { font-size: 0.85rem; }
.answer-correct { color: #34c759; }
.answer-your { color: #ff3b30; margin-bottom: 2px; }
.hidden { display: none; }
@media (max-width: 480px) {
  body { padding: 8px; }
  .stat-value { font-size: 1.5rem; }
  .score-circle { width: 150px; height: 150px; }
  .score-value { font-size: 2.8rem; }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>JLPT N1 æ¨¡æ“¬ãƒ†ã‚¹ãƒˆ</h1>
    <div class="subtitle">ã‚»ãƒƒãƒˆ 13 / å…¨20ã‚»ãƒƒãƒˆ</div>
  </div>
  
  <div id="home">
    <div class="home-content">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="stat-best">--</div>
          <div class="stat-label">æœ€é«˜ã‚¹ã‚³ã‚¢</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-attempts">0</div>
          <div class="stat-label">æŒ‘æˆ¦å›æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">101</div>
          <div class="stat-label">å•é¡Œæ•°</div>
        </div>
      </div>
      <div class="home-actions">
        <button class="btn btn-primary" onclick="startTest()">ğŸ¯ ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
        <div class="btn-row">
          <button class="btn btn-secondary" onclick="reviewWrongFromHome()">âŒ é–“é•ãˆãŸå•é¡Œ</button>
          <button class="btn btn-danger" onclick="resetData()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
    </div>
  </div>
  
  <div id="test" class="hidden">
    <div class="test-header">
      <div class="test-top">
        <div class="test-title" id="test-title">N1 æ¨¡æ“¬ãƒ†ã‚¹ãƒˆ</div>
        <div class="timer" id="timer">165:00</div>
      </div>
      <div class="progress-container">
        <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
        <div class="progress-text" id="progress-text">1/101</div>
      </div>
    </div>
    <div class="question-container">
      <div class="section-badge" id="section-badge">å•é¡Œ</div>
      <div class="question-text" id="question-text"></div>
      <div class="options" id="options"></div>
    </div>
    <div class="test-nav">
      <button class="nav-btn prev" id="prev-btn" onclick="prevQuestion()" disabled>â† å‰ã¸</button>
      <button class="nav-btn next" id="next-btn" onclick="nextQuestion()">æ¬¡ã¸ â†’</button>
    </div>
  </div>
  
  <div id="results" class="hidden">
    <div class="results-content">
      <div class="score-circle">
        <div class="score-value" id="score-value">0%</div>
        <div class="score-detail" id="score-detail">0/0</div>
      </div>
      <div class="pass-badge" id="pass-badge">çµæœ</div>
      <div class="section-scores" id="section-scores"></div>
      <div class="btn-row">
        <button class="btn btn-secondary" id="review-toggle" onclick="toggleAnswerList()">ğŸ“‹ æ­£èª¤ä¸€è¦§ã‚’è¡¨ç¤º</button>
        <button class="btn btn-secondary" onclick="reviewWrong()">âŒ é–“é•ãˆãŸå•é¡Œ</button>
      </div>
      <div class="answer-list hidden" id="answer-list"></div>
      <button class="btn btn-primary" onclick="goHome()" style="margin-top:20px;">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
    </div>
  </div>
</div>

<script>
const LEVEL = 'N1';
const SET_NUM = '13';
const TIME_LIMIT = 165 * 60;
const PASS_SCORE = 60;
const STORAGE_KEY = 'fujisan_mock_n1_13';

const ALL_QUESTIONS = [{"text": "<u>åˆ³ã‚‹</u>ã‚’èª­ã‚“ã§ãã ã•ã„ã€‚", "question": "ã€Œåˆ³ã‚‹ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", "type": "æ¼¢å­—èª­ã¿", "options": ["ãã‚‹ã™", "ãã‚‹", "ãã‚‹ã‚‹", "ãã‚‹ã"], "answer": 1}, {"text": "<u>å‰”ã‚‹</u>ã‚’èª­ã‚“ã§ãã ã•ã„ã€‚", "question": "ã€Œå‰”ã‚‹ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", "type": "æ¼¢å­—èª­ã¿", "options": ["ãˆãã‚‹", "ãˆãã‚‹", "ãˆãã™", "ãˆãã"], "answer": 0}, {"text": "<u>å‰Šã‚‹</u>ã‚’èª­ã‚“ã§ãã ã•ã„ã€‚", "question": "ã€Œå‰Šã‚‹ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", "type": "æ¼¢å­—èª­ã¿", "options": ["ã‘ãšã‚‹", "ã‘ãšã‚‹", "ã‘ãšã™", "ã‘ãšã"], "answer": 0}, {"text": "<u>é›ãˆã‚‹</u>ã‚’èª­ã‚“ã§ãã ã•ã„ã€‚", "question": "ã€Œé›ãˆã‚‹ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", "type": "æ¼¢å­—èª­ã¿", "options": ["ããŸã", "ããŸã‚‹", "ããŸãˆã‚‹", "ããŸã™"], "answer": 2}, {"text": "<u>ç ”ã</u>ã‚’èª­ã‚“ã§ãã ã•ã„ã€‚", "question": "ã€Œç ”ãã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", "type": "æ¼¢å­—èª­ã¿", "options": ["ã¨ãã‚‹", "ã¨ãã", "ã¨ãã™", "ã¨ã"], "answer": 3}, {"text": "<u>ç£¨ã</u>ã‚’èª­ã‚“ã§ãã ã•ã„ã€‚", "question": "ã€Œç£¨ãã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", "type": "æ¼¢å­—èª­ã¿", "options": ["ã¿ãŒã", "ã¿ãŒã", "ã¿ãŒã‚‹", "ã¿ãŒã™"], "answer": 0}, {"text": "ã“ã®äº‹ä»¶ã¯ç¤¾ä¼šã«ï¼ˆã€€ï¼‰ã‚’ä¸ãˆãŸã€‚", "question": "ï¼ˆã€€ï¼‰ã«å…¥ã‚‹è¨€è‘‰ã¯ï¼Ÿ", "type": "æ–‡è„ˆè¦å®š", "options": ["å½±éŸ¿", "æ³¢ç´‹", "æ‰“æ’ƒ", "è¡æ’ƒ"], "answer": 3}, {"text": "å½¼å¥³ã¯ï¼ˆã€€ï¼‰ã®æ‰èƒ½ã‚’æŒã£ã¦ã„ã‚‹ã€‚", "question": "ï¼ˆã€€ï¼‰ã«å…¥ã‚‹è¨€è‘‰ã¯ï¼Ÿ", "type": "æ–‡è„ˆè¦å®š", "options": ["å„ªã‚ŒãŸ", "ç´ æ™´ã‚‰ã—ã„", "å“è¶Š", "éå‡¡"], "answer": 3}, {"text": "ãã®ç†è«–ã¯å­¦ç•Œã§ï¼ˆã€€ï¼‰ã‚’å‘¼ã‚“ã§ã„ã‚‹ã€‚", "question": "ï¼ˆã€€ï¼‰ã«å…¥ã‚‹è¨€è‘‰ã¯ï¼Ÿ", "type": "æ–‡è„ˆè¦å®š", "options": ["è«–äº‰", "è­°è«–", "è¨è«–", "åéŸ¿"], "answer": 0}, {"text": "å½¼ã¯ï¼ˆã€€ï¼‰ã«å¯Œã‚“ã äººç‰©ã ã€‚", "question": "ï¼ˆã€€ï¼‰ã«å…¥ã‚‹è¨€è‘‰ã¯ï¼Ÿ", "type": "æ–‡è„ˆè¦å®š", "options": ["æ©ŸçŸ¥", "çŸ¥æµ", "æ‰è¦š", "é ­è„³"], "answer": 0}, {"text": "ã“ã®å•é¡Œã¯ï¼ˆã€€ï¼‰ã‚’è¦ã™ã‚‹ã€‚", "question": "ï¼ˆã€€ï¼‰ã«å…¥ã‚‹è¨€è‘‰ã¯ï¼Ÿ", "type": "æ–‡è„ˆè¦å®š", "options": ["è€ƒæ…®", "æ¤œè¨", "ç†Ÿæ…®", "å¯©è­°"], "answer": 2}, {"text": "å½¼å¥³ã®ä½œå“ã¯ï¼ˆã€€ï¼‰ã‚’æ”¾ã£ã¦ã„ã‚‹ã€‚", "question": "ï¼ˆã€€ï¼‰ã«å…¥ã‚‹è¨€è‘‰ã¯ï¼Ÿ", "type": "æ–‡è„ˆè¦å®š", "options": ["è¼ã", "ç•°å½©", "å…‰å½©", "è¯"], "answer": 1}, {"text": "ãã®ç™ºè¨€ã¯ï¼ˆã€€ï¼‰ã«æ¬ ã‘ã¦ã„ãŸã€‚", "question": "ï¼ˆã€€ï¼‰ã«å…¥ã‚‹è¨€è‘‰ã¯ï¼Ÿ", "type": "æ–‡è„ˆè¦å®š", "options": ["é…æ…®", "æ€æ…®", "æ³¨æ„", "è€ƒæ…®"], "answer": 0}, {"text": "S13Q1:è¨€ã„æ›ãˆ", "question": "è¿‘ã„æ„å‘³ã¯ï¼Ÿ", "type": "è¨€ã„æ›ãˆé¡ç¾©", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q2:è¨€ã„æ›ãˆ", "question": "è¿‘ã„æ„å‘³ã¯ï¼Ÿ", "type": "è¨€ã„æ›ãˆé¡ç¾©", "options": ["A", "B", "C", "D"], "answer": 2}, {"text": "S13Q3:è¨€ã„æ›ãˆ", "question": "è¿‘ã„æ„å‘³ã¯ï¼Ÿ", "type": "è¨€ã„æ›ãˆé¡ç¾©", "options": ["A", "B", "C", "D"], "answer": 3}, {"text": "S13Q4:è¨€ã„æ›ãˆ", "question": "è¿‘ã„æ„å‘³ã¯ï¼Ÿ", "type": "è¨€ã„æ›ãˆé¡ç¾©", "options": ["A", "B", "C", "D"], "answer": 0}, {"text": "S13Q5:è¨€ã„æ›ãˆ", "question": "è¿‘ã„æ„å‘³ã¯ï¼Ÿ", "type": "è¨€ã„æ›ãˆé¡ç¾©", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q6:è¨€ã„æ›ãˆ", "question": "è¿‘ã„æ„å‘³ã¯ï¼Ÿ", "type": "è¨€ã„æ›ãˆé¡ç¾©", "options": ["A", "B", "C", "D"], "answer": 2}, {"text": "S13Q1:ç”¨æ³•", "question": "æ­£ã—ã„ã®ã¯ï¼Ÿ", "type": "ç”¨æ³•", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q2:ç”¨æ³•", "question": "æ­£ã—ã„ã®ã¯ï¼Ÿ", "type": "ç”¨æ³•", "options": ["A", "B", "C", "D"], "answer": 2}, {"text": "S13Q3:ç”¨æ³•", "question": "æ­£ã—ã„ã®ã¯ï¼Ÿ", "type": "ç”¨æ³•", "options": ["A", "B", "C", "D"], "answer": 3}, {"text": "S13Q4:ç”¨æ³•", "question": "æ­£ã—ã„ã®ã¯ï¼Ÿ", "type": "ç”¨æ³•", "options": ["A", "B", "C", "D"], "answer": 0}, {"text": "S13Q5:ç”¨æ³•", "question": "æ­£ã—ã„ã®ã¯ï¼Ÿ", "type": "ç”¨æ³•", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q6:ç”¨æ³•", "question": "æ­£ã—ã„ã®ã¯ï¼Ÿ", "type": "ç”¨æ³•", "options": ["A", "B", "C", "D"], "answer": 2}, {"text": "S13Q1:æ–‡æ³•", "question": "æ­£ã—ã„ã®ã¯ï¼Ÿ", "type": "æ–‡æ³•å½¢å¼", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q2:æ–‡æ³•", "question": "æ­£ã—ã„ã®ã¯ï¼Ÿ", "type": "æ–‡æ³•å½¢å¼", "options": ["A", "B", "C", "D"], "answer": 2}, {"text": "S13Q3:æ–‡æ³•", "question": "æ­£ã—ã„ã®ã¯ï¼Ÿ", "type": "æ–‡æ³•å½¢å¼", "options": ["A", "B", "C", "D"], "answer": 3}, {"text": "S13Q4:æ–‡æ³•", "question": "æ­£ã—ã„ã®ã¯ï¼Ÿ", "type": "æ–‡æ³•å½¢å¼", "options": ["A", "B", "C", "D"], "answer": 0}, {"text": "S13Q5:æ–‡æ³•", "question": "æ­£ã—ã„ã®ã¯ï¼Ÿ", "type": "æ–‡æ³•å½¢å¼", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q6:æ–‡æ³•", "question": "æ­£ã—ã„ã®ã¯ï¼Ÿ", "type": "æ–‡æ³•å½¢å¼", "options": ["A", "B", "C", "D"], "answer": 2}, {"text": "S13Q7:æ–‡æ³•", "question": "æ­£ã—ã„ã®ã¯ï¼Ÿ", "type": "æ–‡æ³•å½¢å¼", "options": ["A", "B", "C", "D"], "answer": 3}, {"text": "S13Q8:æ–‡æ³•", "question": "æ­£ã—ã„ã®ã¯ï¼Ÿ", "type": "æ–‡æ³•å½¢å¼", "options": ["A", "B", "C", "D"], "answer": 0}, {"text": "S13Q9:æ–‡æ³•", "question": "æ­£ã—ã„ã®ã¯ï¼Ÿ", "type": "æ–‡æ³•å½¢å¼", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q10:æ–‡æ³•", "question": "æ­£ã—ã„ã®ã¯ï¼Ÿ", "type": "æ–‡æ³•å½¢å¼", "options": ["A", "B", "C", "D"], "answer": 2}, {"text": "S13Q1:çµ„ã¿ç«‹ã¦", "question": "â˜…ã«å…¥ã‚‹ã®ã¯ï¼Ÿ", "type": "æ–‡ã®çµ„ã¿ç«‹ã¦", "options": ["1", "2", "3", "4"], "answer": 1}, {"text": "S13Q2:çµ„ã¿ç«‹ã¦", "question": "â˜…ã«å…¥ã‚‹ã®ã¯ï¼Ÿ", "type": "æ–‡ã®çµ„ã¿ç«‹ã¦", "options": ["1", "2", "3", "4"], "answer": 2}, {"text": "S13Q3:çµ„ã¿ç«‹ã¦", "question": "â˜…ã«å…¥ã‚‹ã®ã¯ï¼Ÿ", "type": "æ–‡ã®çµ„ã¿ç«‹ã¦", "options": ["1", "2", "3", "4"], "answer": 3}, {"text": "S13Q4:çµ„ã¿ç«‹ã¦", "question": "â˜…ã«å…¥ã‚‹ã®ã¯ï¼Ÿ", "type": "æ–‡ã®çµ„ã¿ç«‹ã¦", "options": ["1", "2", "3", "4"], "answer": 0}, {"text": "S13Q5:çµ„ã¿ç«‹ã¦", "question": "â˜…ã«å…¥ã‚‹ã®ã¯ï¼Ÿ", "type": "æ–‡ã®çµ„ã¿ç«‹ã¦", "options": ["1", "2", "3", "4"], "answer": 1}, {"text": "S13Q1:æ–‡ç« æ–‡æ³•", "question": "â‘ ã«å…¥ã‚‹ã®ã¯ï¼Ÿ", "type": "æ–‡ç« ã®æ–‡æ³•", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q2:æ–‡ç« æ–‡æ³•", "question": "â‘ ã«å…¥ã‚‹ã®ã¯ï¼Ÿ", "type": "æ–‡ç« ã®æ–‡æ³•", "options": ["A", "B", "C", "D"], "answer": 2}, {"text": "S13Q3:æ–‡ç« æ–‡æ³•", "question": "â‘ ã«å…¥ã‚‹ã®ã¯ï¼Ÿ", "type": "æ–‡ç« ã®æ–‡æ³•", "options": ["A", "B", "C", "D"], "answer": 3}, {"text": "S13Q4:æ–‡ç« æ–‡æ³•", "question": "â‘ ã«å…¥ã‚‹ã®ã¯ï¼Ÿ", "type": "æ–‡ç« ã®æ–‡æ³•", "options": ["A", "B", "C", "D"], "answer": 0}, {"text": "S13Q5:æ–‡ç« æ–‡æ³•", "question": "â‘ ã«å…¥ã‚‹ã®ã¯ï¼Ÿ", "type": "æ–‡ç« ã®æ–‡æ³•", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q1:çŸ­æ–‡", "question": "ç­†è€…ã®ä¸»å¼µã¯ï¼Ÿ", "type": "å†…å®¹ç†è§£ï¼ˆçŸ­æ–‡ï¼‰", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q2:çŸ­æ–‡", "question": "ç­†è€…ã®ä¸»å¼µã¯ï¼Ÿ", "type": "å†…å®¹ç†è§£ï¼ˆçŸ­æ–‡ï¼‰", "options": ["A", "B", "C", "D"], "answer": 2}, {"text": "S13Q3:çŸ­æ–‡", "question": "ç­†è€…ã®ä¸»å¼µã¯ï¼Ÿ", "type": "å†…å®¹ç†è§£ï¼ˆçŸ­æ–‡ï¼‰", "options": ["A", "B", "C", "D"], "answer": 3}, {"text": "S13Q4:çŸ­æ–‡", "question": "ç­†è€…ã®ä¸»å¼µã¯ï¼Ÿ", "type": "å†…å®¹ç†è§£ï¼ˆçŸ­æ–‡ï¼‰", "options": ["A", "B", "C", "D"], "answer": 0}, {"text": "S13Q1:ä¸­æ–‡", "question": "è³ªå•", "type": "å†…å®¹ç†è§£ï¼ˆä¸­æ–‡ï¼‰", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q2:ä¸­æ–‡", "question": "è³ªå•", "type": "å†…å®¹ç†è§£ï¼ˆä¸­æ–‡ï¼‰", "options": ["A", "B", "C", "D"], "answer": 2}, {"text": "S13Q3:ä¸­æ–‡", "question": "è³ªå•", "type": "å†…å®¹ç†è§£ï¼ˆä¸­æ–‡ï¼‰", "options": ["A", "B", "C", "D"], "answer": 3}, {"text": "S13Q4:ä¸­æ–‡", "question": "è³ªå•", "type": "å†…å®¹ç†è§£ï¼ˆä¸­æ–‡ï¼‰", "options": ["A", "B", "C", "D"], "answer": 0}, {"text": "S13Q5:ä¸­æ–‡", "question": "è³ªå•", "type": "å†…å®¹ç†è§£ï¼ˆä¸­æ–‡ï¼‰", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q6:ä¸­æ–‡", "question": "è³ªå•", "type": "å†…å®¹ç†è§£ï¼ˆä¸­æ–‡ï¼‰", "options": ["A", "B", "C", "D"], "answer": 2}, {"text": "S13Q7:ä¸­æ–‡", "question": "è³ªå•", "type": "å†…å®¹ç†è§£ï¼ˆä¸­æ–‡ï¼‰", "options": ["A", "B", "C", "D"], "answer": 3}, {"text": "S13Q8:ä¸­æ–‡", "question": "è³ªå•", "type": "å†…å®¹ç†è§£ï¼ˆä¸­æ–‡ï¼‰", "options": ["A", "B", "C", "D"], "answer": 0}, {"text": "S13Q9:ä¸­æ–‡", "question": "è³ªå•", "type": "å†…å®¹ç†è§£ï¼ˆä¸­æ–‡ï¼‰", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q1:é•·æ–‡", "question": "è³ªå•", "type": "å†…å®¹ç†è§£ï¼ˆé•·æ–‡ï¼‰", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q2:é•·æ–‡", "question": "è³ªå•", "type": "å†…å®¹ç†è§£ï¼ˆé•·æ–‡ï¼‰", "options": ["A", "B", "C", "D"], "answer": 2}, {"text": "S13Q3:é•·æ–‡", "question": "è³ªå•", "type": "å†…å®¹ç†è§£ï¼ˆé•·æ–‡ï¼‰", "options": ["A", "B", "C", "D"], "answer": 3}, {"text": "S13Q4:é•·æ–‡", "question": "è³ªå•", "type": "å†…å®¹ç†è§£ï¼ˆé•·æ–‡ï¼‰", "options": ["A", "B", "C", "D"], "answer": 0}, {"text": "S13Q1:çµ±åˆ", "question": "è³ªå•", "type": "çµ±åˆç†è§£", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q2:çµ±åˆ", "question": "è³ªå•", "type": "çµ±åˆç†è§£", "options": ["A", "B", "C", "D"], "answer": 2}, {"text": "S13Q3:çµ±åˆ", "question": "è³ªå•", "type": "çµ±åˆç†è§£", "options": ["A", "B", "C", "D"], "answer": 3}, {"text": "S13Q1:ä¸»å¼µ", "question": "è³ªå•", "type": "ä¸»å¼µç†è§£ï¼ˆé•·æ–‡ï¼‰", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q2:ä¸»å¼µ", "question": "è³ªå•", "type": "ä¸»å¼µç†è§£ï¼ˆé•·æ–‡ï¼‰", "options": ["A", "B", "C", "D"], "answer": 2}, {"text": "S13Q3:ä¸»å¼µ", "question": "è³ªå•", "type": "ä¸»å¼µç†è§£ï¼ˆé•·æ–‡ï¼‰", "options": ["A", "B", "C", "D"], "answer": 3}, {"text": "S13Q4:ä¸»å¼µ", "question": "è³ªå•", "type": "ä¸»å¼µç†è§£ï¼ˆé•·æ–‡ï¼‰", "options": ["A", "B", "C", "D"], "answer": 0}, {"text": "S13Q1:æƒ…å ±æ¤œç´¢", "question": "è³ªå•", "type": "æƒ…å ±æ¤œç´¢", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q2:æƒ…å ±æ¤œç´¢", "question": "è³ªå•", "type": "æƒ…å ±æ¤œç´¢", "options": ["A", "B", "C", "D"], "answer": 2}, {"text": "S13Q1:èª²é¡Œ", "question": "è³ªå•", "type": "è´è§£ï¼ˆèª²é¡Œç†è§£ï¼‰", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q2:èª²é¡Œ", "question": "è³ªå•", "type": "è´è§£ï¼ˆèª²é¡Œç†è§£ï¼‰", "options": ["A", "B", "C", "D"], "answer": 2}, {"text": "S13Q3:èª²é¡Œ", "question": "è³ªå•", "type": "è´è§£ï¼ˆèª²é¡Œç†è§£ï¼‰", "options": ["A", "B", "C", "D"], "answer": 3}, {"text": "S13Q4:èª²é¡Œ", "question": "è³ªå•", "type": "è´è§£ï¼ˆèª²é¡Œç†è§£ï¼‰", "options": ["A", "B", "C", "D"], "answer": 0}, {"text": "S13Q5:èª²é¡Œ", "question": "è³ªå•", "type": "è´è§£ï¼ˆèª²é¡Œç†è§£ï¼‰", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q1:ãƒã‚¤ãƒ³ãƒˆ", "question": "è³ªå•", "type": "è´è§£ï¼ˆãƒã‚¤ãƒ³ãƒˆç†è§£ï¼‰", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q2:ãƒã‚¤ãƒ³ãƒˆ", "question": "è³ªå•", "type": "è´è§£ï¼ˆãƒã‚¤ãƒ³ãƒˆç†è§£ï¼‰", "options": ["A", "B", "C", "D"], "answer": 2}, {"text": "S13Q3:ãƒã‚¤ãƒ³ãƒˆ", "question": "è³ªå•", "type": "è´è§£ï¼ˆãƒã‚¤ãƒ³ãƒˆç†è§£ï¼‰", "options": ["A", "B", "C", "D"], "answer": 3}, {"text": "S13Q4:ãƒã‚¤ãƒ³ãƒˆ", "question": "è³ªå•", "type": "è´è§£ï¼ˆãƒã‚¤ãƒ³ãƒˆç†è§£ï¼‰", "options": ["A", "B", "C", "D"], "answer": 0}, {"text": "S13Q5:ãƒã‚¤ãƒ³ãƒˆ", "question": "è³ªå•", "type": "è´è§£ï¼ˆãƒã‚¤ãƒ³ãƒˆç†è§£ï¼‰", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q6:ãƒã‚¤ãƒ³ãƒˆ", "question": "è³ªå•", "type": "è´è§£ï¼ˆãƒã‚¤ãƒ³ãƒˆç†è§£ï¼‰", "options": ["A", "B", "C", "D"], "answer": 2}, {"text": "S13Q1:æ¦‚è¦", "question": "è³ªå•", "type": "è´è§£ï¼ˆæ¦‚è¦ç†è§£ï¼‰", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q2:æ¦‚è¦", "question": "è³ªå•", "type": "è´è§£ï¼ˆæ¦‚è¦ç†è§£ï¼‰", "options": ["A", "B", "C", "D"], "answer": 2}, {"text": "S13Q3:æ¦‚è¦", "question": "è³ªå•", "type": "è´è§£ï¼ˆæ¦‚è¦ç†è§£ï¼‰", "options": ["A", "B", "C", "D"], "answer": 3}, {"text": "S13Q4:æ¦‚è¦", "question": "è³ªå•", "type": "è´è§£ï¼ˆæ¦‚è¦ç†è§£ï¼‰", "options": ["A", "B", "C", "D"], "answer": 0}, {"text": "S13Q5:æ¦‚è¦", "question": "è³ªå•", "type": "è´è§£ï¼ˆæ¦‚è¦ç†è§£ï¼‰", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q1: ã“ã®ä»¶ã«ã¤ã„ã¦ã¯ã€éƒ¨é•·ã«ã‚‚ä¸€è¨€ãŠä¼ãˆã—ã¦ãŠã„ãŸæ–¹ãŒã‚ˆã‚ã—ã„ã‹ã¨å­˜ã˜ã¾ã™ãŒã€‚", "question": "ä½•ã¨ç­”ãˆã¾ã™ã‹ã€‚", "type": "è´è§£ï¼ˆå³æ™‚å¿œç­”ï¼‰", "options": ["ãã†ã§ã™ã­ã€å¿µã®ãŸã‚å ±å‘Šã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚", "ã„ã„ãˆã€éƒ¨é•·ã¯ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã‚“ã€‚", "ã¯ã„ã€éƒ¨é•·ã«ä¼ãˆã¦ãã ã•ã„ã€‚"], "answer": 0}, {"text": "S13Q2: ã›ã£ã‹ãã®ãŠç”³ã—å‡ºã§ã™ãŒã€ä»Šå›ã¯è¾é€€ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚", "question": "ä½•ã¨ç­”ãˆã¾ã™ã‹ã€‚", "type": "è´è§£ï¼ˆå³æ™‚å¿œç­”ï¼‰", "options": ["ãã†ã§ã™ã‹ã€æ®‹å¿µã§ã™ãŒä»•æ–¹ã‚ã‚Šã¾ã›ã‚“ã­ã€‚", "ã¯ã„ã€ç”³ã—å‡ºã¦ãã ã•ã„ã€‚", "ã„ã„ãˆã€è¾é€€ã—ã¾ã›ã‚“ã€‚"], "answer": 0}, {"text": "S13Q3: ã”å¤šå¿™ã®ã¨ã“ã‚æã‚Œå…¥ã‚Šã¾ã™ãŒã€å°‘ã€…ãŠæ™‚é–“ã‚’ã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚", "question": "ä½•ã¨ç­”ãˆã¾ã™ã‹ã€‚", "type": "è´è§£ï¼ˆå³æ™‚å¿œç­”ï¼‰", "options": ["ã¯ã„ã€ã©ã®ã‚ˆã†ãªã”ç”¨ä»¶ã§ã—ã‚‡ã†ã‹ã€‚", "ã„ã„ãˆã€å¿™ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚", "æ™‚é–“ã¯å¥½ãã§ã™ã€‚"], "answer": 0}, {"text": "S13Q4: å…ˆæ—¥ã®ä»¶ã€ãã®å¾Œã„ã‹ãŒãªã‚Šã¾ã—ãŸã§ã—ã‚‡ã†ã‹ã€‚", "question": "ä½•ã¨ç­”ãˆã¾ã™ã‹ã€‚", "type": "è´è§£ï¼ˆå³æ™‚å¿œç­”ï¼‰", "options": ["ãŠã‹ã’ã•ã¾ã§ã€ç„¡äº‹è§£æ±ºã„ãŸã—ã¾ã—ãŸã€‚", "å…ˆæ—¥ã¯è‰¯ã‹ã£ãŸã§ã™ã€‚", "ä»¶ã‚’æŒã£ã¦ã„ã¾ã™ã€‚"], "answer": 0}, {"text": "S13Q5: ã“ã®ä¼ç”»ã€ã‚‚ã†å°‘ã—ç·´ã‚Šç›´ã—ãŸæ–¹ãŒã‚ˆã‚ã—ã„ã‹ã¨ã€‚", "question": "ä½•ã¨ç­”ãˆã¾ã™ã‹ã€‚", "type": "è´è§£ï¼ˆå³æ™‚å¿œç­”ï¼‰", "options": ["ãã†ã§ã™ã­ã€å†æ¤œè¨ã—ã¦ã¿ã¾ã™ã€‚", "ã¯ã„ã€ç·´ã£ã¦ãã ã•ã„ã€‚", "ä¼ç”»ã¯å¥½ãã§ã™ã€‚"], "answer": 0}, {"text": "S13Q6: æœ¬æ—¥ã¯ãŠå¿™ã—ã„ä¸­ã€ãŠè¶Šã—ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚", "question": "ä½•ã¨ç­”ãˆã¾ã™ã‹ã€‚", "type": "è´è§£ï¼ˆå³æ™‚å¿œç­”ï¼‰", "options": ["ã“ã¡ã‚‰ã“ãã€ãŠæ‹›ãã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚", "ã¯ã„ã€å¿™ã—ã„ã§ã™ã€‚", "ãŠè¶Šã—ã¯å¥½ãã§ã™ã€‚"], "answer": 0}, {"text": "S13Q7: ã“ã®ä»¶ã«é–¢ã—ã¾ã—ã¦ã¯ã€æ”¹ã‚ã¦ã”é€£çµ¡ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚", "question": "ä½•ã¨ç­”ãˆã¾ã™ã‹ã€‚", "type": "è´è§£ï¼ˆå³æ™‚å¿œç­”ï¼‰", "options": ["æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚", "é€£çµ¡ã¯å¥½ãã§ã™ã€‚", "ã¯ã„ã€é€£çµ¡ã—ã¦ãã ã•ã„ã€‚"], "answer": 0}, {"text": "S13Q8: ã”æ¤œè¨ã„ãŸã ã‘ã¾ã—ãŸã§ã—ã‚‡ã†ã‹ã€‚", "question": "ä½•ã¨ç­”ãˆã¾ã™ã‹ã€‚", "type": "è´è§£ï¼ˆå³æ™‚å¿œç­”ï¼‰", "options": ["ã¯ã„ã€å‰å‘ãã«æ¤œè¨ã•ã›ã¦ã„ãŸã ã„ã¦ãŠã‚Šã¾ã™ã€‚", "æ¤œè¨ã¯å¥½ãã§ã™ã€‚", "ã„ã„ãˆã€æ¤œè¨ã—ã¾ã›ã‚“ã€‚"], "answer": 0}, {"text": "S13Q9: ã“ã®åº¦ã¯ã€å¤§å¤‰ãŠä¸–è©±ã«ãªã‚Šã¾ã—ãŸã€‚", "question": "ä½•ã¨ç­”ãˆã¾ã™ã‹ã€‚", "type": "è´è§£ï¼ˆå³æ™‚å¿œç­”ï¼‰", "options": ["ã„ãˆã„ãˆã€ãŠå½¹ã«ç«‹ã¦ã¦å…‰æ „ã§ã™ã€‚", "ä¸–è©±ã¯å¥½ãã§ã™ã€‚", "ã¯ã„ã€ãŠä¸–è©±ã—ã¦ãã ã•ã„ã€‚"], "answer": 0}, {"text": "S13Q10: ãŠæ‰‹æ•°ã‚’ãŠã‹ã‘ã—ã¦ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚", "question": "ä½•ã¨ç­”ãˆã¾ã™ã‹ã€‚", "type": "è´è§£ï¼ˆå³æ™‚å¿œç­”ï¼‰", "options": ["ã„ãˆã€ãŠæ°—ã«ãªã•ã‚‰ãªã„ã§ãã ã•ã„ã€‚", "æ‰‹æ•°ã¯å¥½ãã§ã™ã€‚", "ã¯ã„ã€ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚"], "answer": 0}, {"text": "S13Q11: ã‚ˆã‚ã—ã‘ã‚Œã°ã€ã”æ„è¦‹ã‚’ãŠèã‹ã›ã„ãŸã ã‘ã¾ã™ã‹ã€‚", "question": "ä½•ã¨ç­”ãˆã¾ã™ã‹ã€‚", "type": "è´è§£ï¼ˆå³æ™‚å¿œç­”ï¼‰", "options": ["ç§è¦‹ã‚’ç”³ã—ä¸Šã’ã¾ã™ã¨...ã€‚", "æ„è¦‹ã¯å¥½ãã§ã™ã€‚", "ã¯ã„ã€èã‹ã›ã¦ãã ã•ã„ã€‚"], "answer": 0}, {"text": "S13Q1:çµ±åˆè´è§£", "question": "è³ªå•", "type": "è´è§£ï¼ˆçµ±åˆç†è§£ï¼‰", "options": ["A", "B", "C", "D"], "answer": 1}, {"text": "S13Q2:çµ±åˆè´è§£", "question": "è³ªå•", "type": "è´è§£ï¼ˆçµ±åˆç†è§£ï¼‰", "options": ["A", "B", "C", "D"], "answer": 2}, {"text": "S13Q3:çµ±åˆè´è§£", "question": "è³ªå•", "type": "è´è§£ï¼ˆçµ±åˆç†è§£ï¼‰", "options": ["A", "B", "C", "D"], "answer": 3}];

let questions = [];
let currentQ = 0;
let answers = {};
let timerInterval = null;
let timeLeft = TIME_LIMIT;
let testResults = null;
let isReview = false;

function init() {
  loadStats();
}

function getData() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { best: null, attempts: 0, wrongQuestions: [] };
  } catch { return { best: null, attempts: 0, wrongQuestions: [] }; }
}

function saveData(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function loadStats() {
  const data = getData();
  document.getElementById('stat-best').textContent = data.best !== null ? data.best + '%' : '--';
  document.getElementById('stat-attempts').textContent = data.attempts || 0;
}

function startTest() {
  questions = ALL_QUESTIONS.map((q, i) => ({ ...q, originalIndex: i }));
  currentQ = 0;
  answers = {};
  timeLeft = TIME_LIMIT;
  testResults = null;
  isReview = false;
  
  showScreen('test');
  document.getElementById('test-title').textContent = LEVEL + ' æ¨¡æ“¬ãƒ†ã‚¹ãƒˆ';
  startTimer();
  renderQuestion();
}

function startTimer() {
  updateTimerDisplay();
  timerInterval = setInterval(() => {
    timeLeft--;
    updateTimerDisplay();
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      submitTest();
    }
  }, 1000);
}

function updateTimerDisplay() {
  const m = Math.floor(timeLeft / 60);
  const s = timeLeft % 60;
  const el = document.getElementById('timer');
  el.textContent = m + ':' + String(s).padStart(2, '0');
  el.className = 'timer' + (timeLeft <= 60 ? ' danger' : timeLeft <= 300 ? ' warning' : '');
}

function renderQuestion() {
  const q = questions[currentQ];
  document.getElementById('section-badge').textContent = q.type || 'å•é¡Œ';
  document.getElementById('question-text').innerHTML = q.text || q.question;
  document.getElementById('progress-text').textContent = (currentQ + 1) + '/' + questions.length;
  document.getElementById('progress-fill').style.width = ((currentQ + 1) / questions.length * 100) + '%';
  
  let html = '';
  const markers = ['A', 'B', 'C', 'D'];
  q.options.forEach((opt, i) => {
    const sel = answers[currentQ] === i ? ' selected' : '';
    html += '<div class="option' + sel + '" onclick="selectOption(' + i + ')">';
    html += '<div class="option-marker">' + markers[i] + '</div>';
    html += '<div class="option-text">' + opt + '</div></div>';
  });
  document.getElementById('options').innerHTML = html;
  
  document.getElementById('prev-btn').disabled = currentQ === 0;
  const nextBtn = document.getElementById('next-btn');
  if (currentQ === questions.length - 1) {
    nextBtn.textContent = 'æå‡ºã™ã‚‹';
    nextBtn.className = 'nav-btn submit';
    nextBtn.onclick = submitTest;
  } else {
    nextBtn.textContent = 'æ¬¡ã¸ â†’';
    nextBtn.className = 'nav-btn next';
    nextBtn.onclick = nextQuestion;
  }
}

function selectOption(idx) {
  answers[currentQ] = idx;
  renderQuestion();
}

function prevQuestion() {
  if (currentQ > 0) { currentQ--; renderQuestion(); }
}

function nextQuestion() {
  if (currentQ < questions.length - 1) { currentQ++; renderQuestion(); }
}

function submitTest() {
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  
  let correct = 0;
  const wrongQuestions = [];
  const sectionScores = {};
  
  questions.forEach((q, i) => {
    const section = q.type || 'å•é¡Œ';
    if (!sectionScores[section]) sectionScores[section] = { correct: 0, total: 0 };
    sectionScores[section].total++;
    
    if (answers[i] === q.answer) {
      correct++;
      sectionScores[section].correct++;
    } else {
      wrongQuestions.push({ ...q, index: q.originalIndex !== undefined ? q.originalIndex : i, userAnswer: answers[i] });
    }
  });
  
  const score = Math.round((correct / questions.length) * 100);
  const passed = score >= PASS_SCORE;
  
  testResults = { score, correct, total: questions.length, passed, sectionScores, wrongQuestions, answers: {...answers} };
  
  if (!isReview) {
    const data = getData();
    data.attempts = (data.attempts || 0) + 1;
    if (data.best === null || score > data.best) data.best = score;
    const existingWrong = data.wrongQuestions || [];
    wrongQuestions.forEach(wq => {
      if (!existingWrong.find(e => e.text === wq.text)) existingWrong.push(wq);
    });
    data.wrongQuestions = existingWrong.filter(wq => {
      const idx = questions.findIndex(q => q.text === wq.text);
      return idx === -1 || answers[idx] !== wq.answer;
    });
    saveData(data);
  }
  
  showResults();
}

function showResults() {
  showScreen('results');
  const { score, correct, total, passed, sectionScores } = testResults;
  
  document.getElementById('score-value').textContent = score + '%';
  document.getElementById('score-detail').textContent = correct + 'å•æ­£è§£ / ' + total + 'å•ä¸­';
  
  const passBadge = document.getElementById('pass-badge');
  passBadge.textContent = passed ? 'åˆæ ¼ãƒ©ã‚¤ãƒ³åˆ°é”ï¼' : 'ä¸åˆæ ¼';
  passBadge.className = 'pass-badge ' + (passed ? 'pass' : 'fail');
  
  let sectionsHtml = '';
  Object.entries(sectionScores).forEach(([section, scores]) => {
    sectionsHtml += '<div class="section-score-card">';
    sectionsHtml += '<div class="section-score-value">' + scores.correct + '/' + scores.total + '</div>';
    sectionsHtml += '<div class="section-score-label">' + section.substring(0, 8) + '</div></div>';
  });
  document.getElementById('section-scores').innerHTML = sectionsHtml;
  
  renderAnswerList();
  loadStats();
}

function renderAnswerList() {
  const { answers: testAnswers } = testResults;
  let html = '';
  questions.forEach((q, i) => {
    const isCorrect = testAnswers[i] === q.answer;
    const userAns = testAnswers[i] !== undefined ? q.options[testAnswers[i]] : 'æœªå›ç­”';
    const correctAns = q.options[q.answer];
    
    html += '<div class="answer-item ' + (isCorrect ? '' : 'wrong') + '">';
    html += '<div class="answer-q-num">å•' + (i + 1) + ' - ' + (q.type || 'å•é¡Œ') + '</div>';
    html += '<div class="answer-q-text">' + (q.text || '').substring(0, 100) + ((q.text || '').length > 100 ? '...' : '') + '</div>';
    html += '<div class="answer-result">';
    if (isCorrect) {
      html += '<div class="answer-correct">âœ“ æ­£è§£: ' + correctAns + '</div>';
    } else {
      html += '<div class="answer-your">âœ— ã‚ãªãŸã®å›ç­”: ' + userAns + '</div>';
      html += '<div class="answer-correct">â—‹ æ­£è§£: ' + correctAns + '</div>';
    }
    html += '</div></div>';
  });
  document.getElementById('answer-list').innerHTML = html;
}

function toggleAnswerList() {
  const list = document.getElementById('answer-list');
  const btn = document.getElementById('review-toggle');
  if (list.classList.contains('hidden')) {
    list.classList.remove('hidden');
    btn.textContent = 'ğŸ“‹ æ­£èª¤ä¸€è¦§ã‚’éš ã™';
  } else {
    list.classList.add('hidden');
    btn.textContent = 'ğŸ“‹ æ­£èª¤ä¸€è¦§ã‚’è¡¨ç¤º';
  }
}

function reviewWrong() {
  if (!testResults || testResults.wrongQuestions.length === 0) {
    alert('é–“é•ãˆãŸå•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ï¼');
    return;
  }
  currentQ = 0;
  answers = {};
  isReview = true;
  questions = testResults.wrongQuestions.map(q => ({...q}));
  testResults = null;
  showScreen('test');
  document.getElementById('test-title').textContent = 'âŒ é–“é•ãˆãŸå•é¡Œ';
  document.getElementById('timer').textContent = 'å¾©ç¿’ä¸­';
  renderQuestion();
}

function reviewWrongFromHome() {
  const data = getData();
  if (!data.wrongQuestions || data.wrongQuestions.length === 0) {
    alert('é–“é•ãˆãŸå•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ï¼');
    return;
  }
  currentQ = 0;
  answers = {};
  isReview = true;
  questions = data.wrongQuestions.map(q => ({...q}));
  showScreen('test');
  document.getElementById('test-title').textContent = 'âŒ é–“é•ãˆãŸå•é¡Œ';
  document.getElementById('timer').textContent = 'å¾©ç¿’ä¸­';
  renderQuestion();
}

function showScreen(id) {
  ['home', 'test', 'results'].forEach(s => {
    document.getElementById(s).classList.toggle('hidden', s !== id);
  });
}

function goHome() {
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  showScreen('home');
  loadStats();
}

function resetData() {
  if (confirm('ã“ã®ãƒ†ã‚¹ãƒˆã®ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
    localStorage.removeItem(STORAGE_KEY);
    loadStats();
    alert('ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
  }
}

init();
</script>
</body>
</html>