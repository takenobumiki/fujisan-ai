<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>JLPT N3-19 模擬テスト</title>
<style>
:root {
  --primary: #af52de;
  --primary-dark: #9332bf;
  --primary-light: #f5e6ff;
  --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --header-gradient: linear-gradient(135deg, #7b1fa2 0%, #ba68c8 100%);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Yu Gothic', sans-serif;
  background: var(--bg-gradient);
  min-height: 100vh;
  padding: 16px;
  -webkit-font-smoothing: antialiased;
}
.container {
  max-width: 680px;
  margin: 0 auto;
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  overflow: hidden;
}
/* Header */
.header {
  background: var(--header-gradient);
  color: #fff;
  padding: 24px 20px;
  text-align: center;
}
.header h1 {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 4px;
  letter-spacing: 0.5px;
}
.header .subtitle {
  font-size: 0.85rem;
  opacity: 0.85;
}
/* Home Screen */
.home-content { padding: 24px; }
.stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 24px;
}
.stat-card {
  background: var(--header-gradient);
  color: #fff;
  padding: 20px 12px;
  border-radius: 16px;
  text-align: center;
}
.stat-value {
  font-size: 2rem;
  font-weight: 700;
  line-height: 1.2;
}
.stat-label {
  font-size: 0.75rem;
  opacity: 0.9;
  margin-top: 4px;
}
.home-actions {
  display: flex;
  flex-direction: column;
  gap: 12px;
  align-items: center;
}
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 14px 28px;
  border: none;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  -webkit-tap-highlight-color: transparent;
}
.btn:active { transform: scale(0.98); }
.btn-primary {
  background: var(--primary);
  color: #fff;
  font-size: 1.1rem;
  padding: 18px 48px;
}
.btn-primary:hover { background: var(--primary-dark); }
.btn-secondary {
  background: #f0f0f5;
  color: #333;
}
.btn-secondary:hover { background: #e0e0e5; }
.btn-danger {
  background: #ff3b30;
  color: #fff;
}
.btn-row {
  display: flex;
  gap: 12px;
  justify-content: center;
  flex-wrap: wrap;
}
/* Test Screen */
.test-header {
  background: var(--header-gradient);
  color: #fff;
  padding: 16px 20px;
}
.test-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}
.test-title {
  font-size: 1rem;
  font-weight: 600;
}
.timer {
  font-size: 1.5rem;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
}
.timer.warning { color: #ffcc00; }
.timer.danger { color: #ff3b30; animation: blink 1s infinite; }
@keyframes blink { 50% { opacity: 0.6; } }
.progress-container {
  display: flex;
  align-items: center;
  gap: 12px;
}
.progress-bar {
  flex: 1;
  height: 6px;
  background: rgba(255,255,255,0.3);
  border-radius: 3px;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: #fff;
  transition: width 0.3s ease;
}
.progress-text {
  font-size: 0.85rem;
  font-weight: 500;
  white-space: nowrap;
}
/* Question */
.question-container { padding: 20px; }
.section-badge {
  display: inline-block;
  background: var(--primary-light);
  color: var(--primary-dark);
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
  margin-bottom: 16px;
}
.question-text {
  font-size: 1.05rem;
  line-height: 1.8;
  color: #1a1a1a;
  margin-bottom: 20px;
  padding: 16px;
  background: #f8f9fa;
  border-radius: 12px;
  border-left: 4px solid var(--primary);
}
.question-text u { 
  text-decoration: none;
  background: var(--primary-light);
  padding: 2px 4px;
  border-radius: 4px;
  font-weight: 600;
}
.options { display: flex; flex-direction: column; gap: 10px; }
.option {
  display: flex;
  align-items: center;
  padding: 14px 16px;
  background: #fff;
  border: 2px solid #e5e5ea;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.15s ease;
  -webkit-tap-highlight-color: transparent;
}
.option:hover { border-color: var(--primary); background: var(--primary-light); }
.option.selected { border-color: var(--primary); background: var(--primary-light); }
.option.correct { border-color: #34c759; background: #e8f9ee; }
.option.wrong { border-color: #ff3b30; background: #ffebea; }
.option-label {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--primary);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 0.9rem;
  margin-right: 14px;
  flex-shrink: 0;
}
.option.selected .option-label { background: var(--primary-dark); }
.option.correct .option-label { background: #34c759; }
.option.wrong .option-label { background: #ff3b30; }
.option-text { flex: 1; font-size: 1rem; line-height: 1.5; }
/* Navigation */
.nav-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  background: #f8f9fa;
  border-top: 1px solid #e5e5ea;
}
.nav-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 12px 20px;
  border: none;
  border-radius: 10px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.nav-btn-prev, .nav-btn-next {
  background: var(--primary);
  color: #fff;
}
.nav-btn-prev:hover, .nav-btn-next:hover { background: var(--primary-dark); }
.nav-btn-submit {
  background: #34c759;
  color: #fff;
  padding: 12px 24px;
}
.nav-btn-submit:hover { background: #2db350; }
.nav-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}
/* Results */
.results-content { padding: 24px; }
.score-card {
  background: var(--header-gradient);
  color: #fff;
  padding: 32px 24px;
  border-radius: 20px;
  text-align: center;
  margin-bottom: 24px;
}
.score-value {
  font-size: 4rem;
  font-weight: 800;
  line-height: 1;
  margin-bottom: 8px;
}
.score-detail {
  font-size: 1rem;
  opacity: 0.9;
}
.pass-badge {
  display: inline-block;
  padding: 8px 20px;
  border-radius: 20px;
  font-weight: 700;
  margin-top: 12px;
}
.pass-badge.pass { background: #34c759; }
.pass-badge.fail { background: #ff3b30; }
/* Section Scores */
.section-scores {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 12px;
  margin-bottom: 24px;
}
.section-score-card {
  background: #f8f9fa;
  padding: 16px;
  border-radius: 12px;
  text-align: center;
  border-left: 4px solid var(--primary);
}
.section-score-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--primary);
}
.section-score-label {
  font-size: 0.8rem;
  color: #666;
  margin-top: 4px;
}
/* Answer Review */
.review-section {
  margin-top: 24px;
}
.review-title {
  font-size: 1.1rem;
  font-weight: 700;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.review-toggle {
  background: var(--primary-light);
  color: var(--primary);
  border: none;
  padding: 12px 20px;
  border-radius: 10px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  margin-bottom: 16px;
}
.answer-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
  max-height: 400px;
  overflow-y: auto;
}
.answer-item {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 16px;
  border-left: 4px solid #34c759;
}
.answer-item.wrong {
  border-left-color: #ff3b30;
  background: #fff5f5;
}
.answer-q-num {
  font-size: 0.8rem;
  font-weight: 600;
  color: #666;
  margin-bottom: 8px;
}
.answer-q-text {
  font-size: 0.95rem;
  line-height: 1.6;
  margin-bottom: 12px;
}
.answer-result {
  display: flex;
  flex-direction: column;
  gap: 6px;
  font-size: 0.9rem;
}
.answer-your {
  color: #ff3b30;
}
.answer-correct {
  color: #34c759;
  font-weight: 600;
}
/* Results Actions */
.results-actions {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 24px;
}
/* Audio Button */
.audio-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: var(--primary);
  color: #fff;
  border: none;
  padding: 12px 24px;
  border-radius: 25px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  margin-bottom: 16px;
  transition: all 0.2s;
}
.audio-btn:hover { background: var(--primary-dark); }
.audio-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.audio-btn.playing { animation: pulse 1s infinite; }
@keyframes pulse { 50% { opacity: 0.7; } }
/* Utilities */
.hidden { display: none !important; }
/* Responsive */
@media (max-width: 480px) {
  body { padding: 8px; }
  .header { padding: 20px 16px; }
  .header h1 { font-size: 1.3rem; }
  .stats-grid { gap: 8px; }
  .stat-card { padding: 16px 8px; }
  .stat-value { font-size: 1.6rem; }
  .question-container { padding: 16px; }
  .question-text { padding: 12px; font-size: 1rem; }
  .option { padding: 12px 14px; }
  .nav-bar { padding: 12px 16px; }
  .nav-btn { padding: 10px 16px; font-size: 0.9rem; }
  .score-value { font-size: 3rem; }
}
</style>
</head>
<body>
<div class="container">
  <!-- Header -->
  <div class="header">
    <h1>🇯🇵 JLPT N3-19</h1>
    <div class="subtitle">第19回模擬テスト | v2.0.0</div>
  </div>

  <!-- Home Screen -->
  <div id="home" class="home-content">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="stat-best">-%</div>
        <div class="stat-label">最高スコア</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-attempts">0</div>
        <div class="stat-label">受験回数</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-wrong">0</div>
        <div class="stat-label">復習問題</div>
      </div>
    </div>
    <div class="home-actions">
      <button class="btn btn-primary" onclick="startTest()">📝 テスト開始</button>
      <div class="btn-row">
        <button class="btn btn-secondary" onclick="startReview()">📚 復習モード</button>
        <button class="btn btn-danger" onclick="resetData()">🗑️ リセット</button>
      </div>
    </div>
  </div>

  <!-- Test Screen -->
  <div id="test" class="hidden">
    <div class="test-header">
      <div class="test-top">
        <div class="test-title" id="test-title">模擬テスト</div>
        <div class="timer" id="timer">00:00</div>
      </div>
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div class="progress-text" id="progress-text">1 / 15</div>
      </div>
    </div>
    <div class="question-container" id="question-container"></div>
    <div class="nav-bar">
      <button class="nav-btn nav-btn-prev" id="btn-prev" onclick="prevQ()">← 前へ</button>
      <button class="nav-btn nav-btn-submit" id="btn-submit" onclick="submitTest()">採点する</button>
      <button class="nav-btn nav-btn-next" id="btn-next" onclick="nextQ()">次へ →</button>
    </div>
  </div>

  <!-- Results Screen -->
  <div id="results" class="results-content hidden">
    <div class="score-card">
      <div class="score-value" id="score-value">0%</div>
      <div class="score-detail" id="score-detail">0問正解 / 15問中</div>
      <div class="pass-badge" id="pass-badge">合格</div>
    </div>
    <div class="section-scores" id="section-scores"></div>
    <div class="review-section">
      <button class="review-toggle" id="review-toggle" onclick="toggleAnswerList()">
        📋 正誤一覧を表示
      </button>
      <div class="answer-list hidden" id="answer-list"></div>
    </div>
    <div class="results-actions">
      <button class="btn btn-primary" onclick="reviewWrong()">❌ 間違えた問題を復習</button>
      <button class="btn btn-secondary" onclick="startTest()">🔄 もう一度挑戦</button>
      <button class="btn btn-secondary" onclick="goHome()">🏠 ホームに戻る</button>
    </div>
  </div>
</div>

<script>
// Test Data (will be replaced)
const TEST = {"id":"N3-19","title":"N3模擬テスト 第19回","questions":[{"text":"毎日、会社まで電車で（通う）。","question":"（通う）の読み方は？","options":["とおう","かよう","つうう","よう"],"answer":1,"type":"漢字読み"},{"text":"友達に手紙を（届ける）。","question":"（届ける）の読み方は？","options":["つける","ととける","ととこける","とどける"],"answer":3,"type":"漢字読み"},{"text":"新しい仕事に（慣れる）まで時間がかかった。","question":"（慣れる）の読み方は？","options":["かれる","たれる","なれる","つれる"],"answer":2,"type":"漢字読み"},{"text":"試験の結果を（調べる）。","question":"（調べる）の読み方は？","options":["しらべる","ちょうべる","たべる","のべる"],"answer":0,"type":"漢字読み"},{"text":"彼女は音楽を（楽しむ）のが好きだ。","question":"（楽しむ）の読み方は？","options":["らくしむ","がくしむ","ようしむ","たのしむ"],"answer":3,"type":"漢字読み"},{"text":"この問題を（解く）のに１時間かかった。","question":"（解く）の読み方は？","options":["かく","ほどく","とく","さく"],"answer":2,"type":"漢字読み"},{"text":"山を（登る）のは大変だった。","question":"（登る）の読み方は？","options":["のぼる","あがる","とうる","とる"],"answer":0,"type":"漢字読み"},{"text":"電気を（消す）のを忘れた。","question":"（消す）の読み方は？","options":["けす","きす","しょうす","かす"],"answer":0,"type":"漢字読み"},{"text":"あしたは（あめ）がふるでしょう。","question":"（あめ）の書き方は？","options":["雪","風","霧","雨"],"answer":3,"type":"表記"},{"text":"この（くすり）を飲んでください。","question":"（くすり）の書き方は？","options":["薬","葉","草","花"],"answer":0,"type":"表記"},{"text":"（えき）まで歩いて５分です。","question":"（えき）の書き方は？","options":["駐","軽","駅","転"],"answer":2,"type":"表記"},{"text":"彼は（しんせつ）な人です。","question":"（しんせつ）の書き方は？","options":["新設","心説","親切","真説"],"answer":2,"type":"表記"},{"text":"昨日、（えいが）を見ました。","question":"（えいが）の書き方は？","options":["映画","栄画","永画","泳画"],"answer":0,"type":"表記"},{"text":"この問題は（かんたん）です。","question":"（かんたん）の書き方は？","options":["感嘆","簡単","乾担","完端"],"answer":1,"type":"表記"},{"text":"彼は毎日（　　）して、日本語が上手になった。","question":"（　）に入る言葉は？","options":["準備","練習","運動","休憩"],"answer":1,"type":"文脈規定"},{"text":"この問題は（　　）すぎて、解けない。","question":"（　）に入る言葉は？","options":["やさしい","おもしろい","難しい","つまらない"],"answer":2,"type":"文脈規定"},{"text":"電車が（　　）して、会社に遅れた。","question":"（　）に入る言葉は？","options":["到着","遅延","出発","運行"],"answer":1,"type":"文脈規定"},{"text":"彼女の話は（　　）信じられない。","question":"（　）に入る言葉は？","options":["ちょっと","たぶん","きっと","とても"],"answer":3,"type":"文脈規定"},{"text":"この薬を飲んだら、頭痛が（　　）した。","question":"（　）に入る言葉は？","options":["壊れた","曲がった","折れた","治った"],"answer":3,"type":"文脈規定"},{"text":"この店は（　　）がいいから、よく来る。","question":"（　）に入る言葉は？","options":["トラブル","クレーム","サービス","キャンセル"],"answer":2,"type":"文脈規定"},{"text":"彼女は（　　）な人で、誰とでも仲良くなれる。","question":"（　）に入る言葉は？","options":["内気","社交的","消極的","悲観的"],"answer":1,"type":"文脈規定"},{"text":"この計画を（　　）するには、時間がかかる。","question":"（　）に入る言葉は？","options":["中止","延期","実行","拒否"],"answer":2,"type":"文脈規定"},{"text":"彼の説明は（　　）で、わかりやすい。","question":"（　）に入る言葉は？","options":["明確","曖昧","複雑","抽象的"],"answer":0,"type":"文脈規定"},{"text":"試験に（　　）するために、毎日勉強している。","question":"（　）に入る言葉は？","options":["不合格","失敗","棄権","合格"],"answer":3,"type":"文脈規定"},{"text":"彼女は（　　）な性格で、すぐに怒る。","question":"（　）に入る言葉は？","options":["気長","のんき","短気","楽観的"],"answer":2,"type":"文脈規定"},{"text":"この映画はとても（面白い）。","question":"（面白い）と似た意味は？","options":["つまらない","興味深い","悲しい","怖い"],"answer":1,"type":"言い換え"},{"text":"彼は（すぐに）来ると言った。","question":"（すぐに）と似た意味は？","options":["ゆっくり","まもなく","たぶん","決して"],"answer":1,"type":"言い換え"},{"text":"この問題は（簡単）だ。","question":"（簡単）と似た意味は？","options":["難しい","複雑","やさしい","面倒"],"answer":2,"type":"言い換え"},{"text":"彼女は（親切）な人だ。","question":"（親切）と似た意味は？","options":["やさしい","厳しい","冷たい","怖い"],"answer":0,"type":"言い換え"},{"text":"（たくさん）の人が来た。","question":"（たくさん）と似た意味は？","options":["少し","一人","誰も","大勢"],"answer":3,"type":"言い換え"},{"text":"「頭」の使い方で正しいものは？","question":"正しい文を選んでください。","options":["頭を食べる","頭がいい人だ","頭を着る","頭に乗る"],"answer":1,"type":"用法"},{"text":"「足」の使い方で正しいものは？","question":"正しい文を選んでください。","options":["足を読む","足が速い","足を聞く","足を書く"],"answer":1,"type":"用法"},{"text":"「手」の使い方で正しいものは？","question":"正しい文を選んでください。","options":["手を飲む","手を見える","手を聞こえる","手を洗う"],"answer":3,"type":"用法"},{"text":"「目」の使い方で正しいものは？","question":"正しい文を選んでください。","options":["目が覚める","目を食べる","目を書く","目を着る"],"answer":0,"type":"用法"},{"text":"「耳」の使い方で正しいものは？","question":"正しい文を選んでください。","options":["耳を傾ける","耳を食べる","耳を書く","耳を着る"],"answer":0,"type":"用法"},{"text":"雨が（　　）、試合は中止になった。","question":"（　）に入る言葉は？","options":["降ったから","降ったので","降ったために","降ったため"],"answer":1,"type":"文法形式"},{"text":"彼女は日本語（　　）英語も話せる。","question":"（　）に入る言葉は？","options":["しか","だけでなく","ばかり","だけ"],"answer":1,"type":"文法形式"},{"text":"電車に乗っている（　　）、本を読んでいた。","question":"（　）に入る言葉は？","options":["うちに","間","ところ","ばかり"],"answer":1,"type":"文法形式"},{"text":"忙しい（　　）、旅行に行きたい。","question":"（　）に入る言葉は？","options":["ので","から","けど","し"],"answer":2,"type":"文法形式"},{"text":"この料理は母が作った（　　）おいしい。","question":"（　）に入る言葉は？","options":["ばかりで","だけあって","ことで","ものに"],"answer":1,"type":"文法形式"},{"text":"彼は病気（　　）仕事を休んだ。","question":"（　）に入る言葉は？","options":["に","で","を","が"],"answer":1,"type":"文法形式"},{"text":"明日までに（　　）ください。","question":"（　）に入る言葉は？","options":["終わって","終わり","終わる","終わらせて"],"answer":3,"type":"文法形式"},{"text":"この本は難しくて（　　）。","question":"（　）に入る言葉は？","options":["読めない","読まない","読みない","読わない"],"answer":0,"type":"文法形式"},{"text":"日本に（　　）一年になる。","question":"（　）に入る言葉は？","options":["来てから","来るから","来たから","来てで"],"answer":0,"type":"文法形式"},{"text":"彼女は歌（　　）上手だ。","question":"（　）に入る言葉は？","options":["を","に","が","で"],"answer":2,"type":"文法形式"},{"text":"雨が降り（　　）だ。","question":"（　）に入る言葉は？","options":["そう","よう","みたい","らしい"],"answer":0,"type":"文法形式"},{"text":"彼は何も（　　）帰ってしまった。","question":"（　）に入る言葉は？","options":["言わないで","言わなくて","言わないに","言わずに"],"answer":3,"type":"文法形式"},{"text":"この問題は難しく（　　）やさしくもない。","question":"（　）に入る言葉は？","options":["て","は","も","が"],"answer":2,"type":"文法形式"},{"text":"私は ＿＿ ★ ＿＿ ＿＿ 行った。","question":"★に入るものは？（1.友達と 2.映画を 3.見に 4.昨日）","options":["友達と","映画を","見に","昨日"],"answer":2,"type":"文の組み立て"},{"text":"彼女は ＿＿ ＿＿ ★ ＿＿ いる。","question":"★に入るものは？（1.日本語を 2.勉強して 3.毎日 4.大学で）","options":["勉強して","日本語を","毎日","大学で"],"answer":0,"type":"文の組み立て"},{"text":"この本は ＿＿ ★ ＿＿ ＿＿ ない。","question":"★に入るものは？（1.難しくて 2.読む 3.ことが 4.でき）","options":["難しくて","読む","でき","ことが"],"answer":3,"type":"文の組み立て"},{"text":"先生に ＿＿ ＿＿ ★ ＿＿ た。","question":"★に入るものは？（1.書き方を 2.漢字の 3.教えてもらっ 4.正しい）","options":["書き方を","漢字の","教えてもらっ","正しい"],"answer":2,"type":"文の組み立て"},{"text":"天気が ＿＿ ★ ＿＿ ＿＿ ましょう。","question":"★に入るものは？（1.よければ 2.散歩に 3.公園へ 4.行き）","options":["よければ","散歩に","公園へ","行き"],"answer":1,"type":"文の組み立て"},{"text":"昨日、友達と買い物に（1）。デパートでかわいい服を（2）。でも、値段が高かったので（3）。","question":"（1）に入るものは？","options":["行く","行って","行き","行った"],"answer":3,"type":"文章の文法"},{"text":"日本語の勉強は（1）。毎日漢字を（2）覚えている。来年は（3）と思う。","question":"（2）に入るものは？","options":["10個ずつ","10個だけ","10個ほど","10個しか"],"answer":0,"type":"文章の文法"},{"text":"田中さんは（1）人だ。いつも（2）、みんなに（3）。","question":"（3）に入るものは？","options":["好きだ","好む","好かれている","好きになる"],"answer":2,"type":"文章の文法"},{"text":"今日は天気が（1）。公園に（2）人がたくさん（3）。","question":"（1）に入るものは？","options":["いいので","悪いので","曇りで","雨で"],"answer":0,"type":"文章の文法"},{"text":"この店のラーメンは（1）。スープが（2）、麺も（3）。","question":"（2）に入るものは？","options":["おいしいから","おいしいので","おいしくても","おいしくて"],"answer":3,"type":"文章の文法"},{"text":"最近、デパートやスーパーで自分で計算をする「セルフレジ」が増えています。店の人がいなくてもいいので、店は助かりますが、慣れていない人には難しいこともあるようです。誰でも簡単に使えるようになるには、機械の画面をもっと分かりやすくする必要があります。","question":"筆者は、セルフレジをどうすればいいと考えていますか。","options":["慣れている人だけが使うようにする","店の人を増やして手伝ってもらう","画面を分かりやすくして使いやすくする","機械を使わないようにする"],"answer":2,"type":"読解（短文）"},{"text":"子供の頃、私は外で遊ぶより家で本を読むのが好きでした。特に冒険の物語が大好きで、読んでいる間は自分もその世界にいるような気がしたものです。大人になった今でも、忙しい時こそ本を読んで、リフレッシュするようにしています。","question":"筆者にとって読書とは何ですか。","options":["忙しさを忘れて気分を変えるもの","実際に冒険に出かける準備","子供の頃の勉強の習慣","新しい言葉を覚えるための道具"],"answer":0,"type":"読解（短文）"},{"text":"会社の近くに新しい公園ができました。とても広くて、たくさんの木や花があります。昼休みにそこへ行くと、とてもリラックスできます。今までは自分の席でお弁当を食べていましたが、これからは晴れた日には公園に行こうと思います。","question":"筆者はこれからどうするつもりですか。","options":["自分の席でお弁当を食べる","会社の中に木や花を植える","晴れた日には新しい公園へ行く","昼休みに新しいお弁当を買いに行く"],"answer":2,"type":"読解（短文）"},{"text":"お知らせ：明日のハイキングは、雨の予報のため中止します。楽しみにしていた方には申し訳ありません。代わりに、来週の日曜日に行う予定です。時間と場所は変わりません。参加できない人は、今日の午後5時までに連絡してください。","question":"来週のハイキングに参加できない人はどうしますか。","options":["明日の朝、集合場所に行く","今日中に連絡をする","別の場所を予約する","次の雨の日まで待つ"],"answer":1,"type":"読解（短文）"},{"text":"日本では、四月に新学期が始まります。この時期になると、桜が咲き、入学式や入社式が行われます。新しい環境で生活を始める人が多いので、引っ越しも増えます。引っ越し業者は大変忙しくなり、予約が取りにくくなることもあります。三月中に予約をしておくのが良いでしょう。","question":"四月に引っ越しをする時、何に気をつけるべきですか。","options":["早めに業者を予約する","桜の開花時期を確認する","入学式に出席する","新しい学校を探す"],"answer":0,"type":"読解（中文）"},{"text":"日本では、四月に新学期が始まります。この時期になると、桜が咲き、入学式や入社式が行われます。新しい環境で生活を始める人が多いので、引っ越しも増えます。引っ越し業者は大変忙しくなり、予約が取りにくくなることもあります。三月中に予約をしておくのが良いでしょう。","question":"なぜ四月は引っ越し業者が忙しいのですか。","options":["桜を見に行く人が多いから","夏休みが始まるから","業者の数が少ないから","新しい生活を始める人が多いから"],"answer":3,"type":"読解（中文）"},{"text":"日本では、四月に新学期が始まります。この時期になると、桜が咲き、入学式や入社式が行われます。新しい環境で生活を始める人が多いので、引っ越しも増えます。引っ越し業者は大変忙しくなり、予約が取りにくくなることもあります。三月中に予約をしておくのが良いでしょう。","question":"この時期の店はどうなりますか。","options":["混雑する","閉まっている","空いている","安くなる"],"answer":0,"type":"読解（中文）"},{"text":"私の趣味は料理です。最初は失敗ばかりでしたが、今では家族においしいと言ってもらえるようになりました。料理の良いところは、作る過程も楽しいし、食べる時も幸せを感じられることです。また、健康的な食事を自分で管理できるのも大きなメリットです。","question":"筆者が料理を続ける理由は何ですか。","options":["お金が節約できるから","家族に頼まれたから","作る過程と食べる時の両方が楽しいから","他に趣味がないから"],"answer":2,"type":"読解（中文）"},{"text":"私の趣味は料理です。最初は失敗ばかりでしたが、今では家族においしいと言ってもらえるようになりました。料理の良いところは、作る過程も楽しいし、食べる時も幸せを感じられることです。また、健康的な食事を自分で管理できるのも大きなメリットです。","question":"筆者は最初、料理がどうでしたか。","options":["上手だった","嫌いだった","簡単だった","失敗が多かった"],"answer":3,"type":"読解（中文）"},{"text":"私の趣味は料理です。最初は失敗ばかりでしたが、今では家族においしいと言ってもらえるようになりました。料理の良いところは、作る過程も楽しいし、食べる時も幸せを感じられることです。また、健康的な食事を自分で管理できるのも大きなメリットです。","question":"自分で料理を作ることのメリットは何ですか。","options":["時間が節約できる","外食より高い","材料を買わなくていい","健康的な食事を管理できる"],"answer":3,"type":"読解（中文）"},{"text":"日本では、電車やバスの中で携帯電話で話すことはマナー違反とされています。これは他の国ではあまり見られない文化です。なぜ日本ではこのようなルールがあるのでしょうか。\n\n一つの理由は、日本人が「周りの人に迷惑をかけない」ことを大切にする文化を持っているからです。電車の中は狭い空間で、多くの人が一緒にいます。そこで大きな声で電話をすると、周りの人が不快に感じることがあります。\n\nまた、日本の電車は非常に混雑していることが多いです。朝の通勤時間には、電車の中で動くこともできないほど混むことがあります。そのような状況で電話をすると、より迷惑になります。\n\nしかし、最近ではこのルールも変わりつつあります。新幹線のように長距離を走る電車では、デッキで電話をすることが許可されています。また、若い世代の中には、このルールを厳しすぎると感じる人もいます。\n\n文化やマナーは時代とともに変わるものです。しかし、「周りの人のことを考える」という基本的な考え方は、これからも大切にしていくべきだと思います。","question":"日本の電車で携帯電話で話すことは、どう考えられていますか。","options":["普通のことだ","マナー違反だ","推奨されている","法律で禁止されている"],"answer":1,"type":"読解（長文）"},{"text":"日本では、電車やバスの中で携帯電話で話すことはマナー違反とされています。これは他の国ではあまり見られない文化です。なぜ日本ではこのようなルールがあるのでしょうか。\n\n一つの理由は、日本人が「周りの人に迷惑をかけない」ことを大切にする文化を持っているからです。電車の中は狭い空間で、多くの人が一緒にいます。そこで大きな声で電話をすると、周りの人が不快に感じることがあります。\n\nまた、日本の電車は非常に混雑していることが多いです。朝の通勤時間には、電車の中で動くこともできないほど混むことがあります。そのような状況で電話をすると、より迷惑になります。\n\nしかし、最近ではこのルールも変わりつつあります。新幹線のように長距離を走る電車では、デッキで電話をすることが許可されています。また、若い世代の中には、このルールを厳しすぎると感じる人もいます。\n\n文化やマナーは時代とともに変わるものです。しかし、「周りの人のことを考える」という基本的な考え方は、これからも大切にしていくべきだと思います。","question":"日本人が電車で電話をしない理由は何ですか。","options":["電話が高いから","電波が悪いから","周りに迷惑をかけないため","話す相手がいないから"],"answer":2,"type":"読解（長文）"},{"text":"日本では、電車やバスの中で携帯電話で話すことはマナー違反とされています。これは他の国ではあまり見られない文化です。なぜ日本ではこのようなルールがあるのでしょうか。\n\n一つの理由は、日本人が「周りの人に迷惑をかけない」ことを大切にする文化を持っているからです。電車の中は狭い空間で、多くの人が一緒にいます。そこで大きな声で電話をすると、周りの人が不快に感じることがあります。\n\nまた、日本の電車は非常に混雑していることが多いです。朝の通勤時間には、電車の中で動くこともできないほど混むことがあります。そのような状況で電話をすると、より迷惑になります。\n\nしかし、最近ではこのルールも変わりつつあります。新幹線のように長距離を走る電車では、デッキで電話をすることが許可されています。また、若い世代の中には、このルールを厳しすぎると感じる人もいます。\n\n文化やマナーは時代とともに変わるものです。しかし、「周りの人のことを考える」という基本的な考え方は、これからも大切にしていくべきだと思います。","question":"新幹線では電話についてどうなっていますか。","options":["絶対に禁止されている","デッキで話すことは許可されている","どこでも自由に話せる","お金を払えば話せる"],"answer":1,"type":"読解（長文）"},{"text":"日本では、電車やバスの中で携帯電話で話すことはマナー違反とされています。これは他の国ではあまり見られない文化です。なぜ日本ではこのようなルールがあるのでしょうか。\n\n一つの理由は、日本人が「周りの人に迷惑をかけない」ことを大切にする文化を持っているからです。電車の中は狭い空間で、多くの人が一緒にいます。そこで大きな声で電話をすると、周りの人が不快に感じることがあります。\n\nまた、日本の電車は非常に混雑していることが多いです。朝の通勤時間には、電車の中で動くこともできないほど混むことがあります。そのような状況で電話をすると、より迷惑になります。\n\nしかし、最近ではこのルールも変わりつつあります。新幹線のように長距離を走る電車では、デッキで電話をすることが許可されています。また、若い世代の中には、このルールを厳しすぎると感じる人もいます。\n\n文化やマナーは時代とともに変わるものです。しかし、「周りの人のことを考える」という基本的な考え方は、これからも大切にしていくべきだと思います。","question":"筆者が最も伝えたいことは何ですか。","options":["周りを考える気持ちが大切だ","電車で電話をするべきだ","ルールは絶対に守るべきだ","日本の文化は変わるべきではない"],"answer":0,"type":"読解（長文）"},{"text":"【ひまわりパソコン教室 受講案内】\n■コース：はじめてコース（3,000円）、ビジネスコース（5,000円）\n■時間：90分\n■定員：各回5名\n※2名以上で一緒に申し込むと、1人につき500円安くなります。","question":"友達と2人で「ビジネスコース」に申し込むと、1人いくらになりますか。","options":["2,500円","3,000円","5,000円","4,500円"],"answer":3,"type":"読解（情報検索）"},{"text":"【ひまわりパソコン教室 受講案内】\n■コース：はじめてコース（3,000円）、ビジネスコース（5,000円）\n■時間：90分\n■定員：各回5名\n※2名以上で一緒に申し込むと、1人につき500円安くなります。","question":"一人で「はじめてコース」に申し込むと、いくらですか。","options":["2,500円","3,000円","4,500円","5,000円"],"answer":1,"type":"読解（情報検索）"},{"audio":"デパートで男の人と店員が話しています。男の人は何を買いますか。男の人：すみません、このかばん、黒はありますか。店員：申し訳ございません。黒は売り切れです。茶色と青と白ならございますが。男の人：そうですか。じゃ、茶色をください。店員：かしこまりました。男の人は何を買いますか。","question":"男の人は何を買いますか。","options":["黒いかばん","青いかばん","白いかばん","茶色いかばん"],"answer":3,"type":"課題理解"},{"audio":"学校で先生が話しています。学生は明日何を持ってきますか。先生：明日は期末テストです。必ず本とノートを持ってきてください。辞書は使えませんから、持ってこなくていいです。わかりましたか。学生は明日何を持ってきますか。","question":"学生は明日何を持ってきますか。","options":["辞書だけ","ノートだけ","本とノート","本だけ"],"answer":2,"type":"課題理解"},{"audio":"会社で女の人と男の人が話しています。男の人はこれから何をしますか。女の人：田中さん、3時から会議があるんですが、資料はできましたか。男の人：すみません、まだです。今から作ります。女の人：じゃ、会議には私が出ますから、資料を作ってください。男の人：わかりました。男の人はこれから何をしますか。","question":"男の人はこれから何をしますか。","options":["会議に出る","資料を作る","電話をかける","昼ご飯を食べる"],"answer":1,"type":"課題理解"},{"audio":"駅でアナウンスがあります。電車に乗りたい人はどうしますか。アナウンス：お客様にお知らせいたします。東京行きの電車は、本日、5番線から3番線に変更になりました。東京方面へお越しの方は、3番線へお越しください。電車に乗りたい人はどうしますか。","question":"電車に乗りたい人はどうしますか。","options":["3番線に行く","5番線に行く","バスに乗る","タクシーに乗る"],"answer":0,"type":"課題理解"},{"audio":"友達と電話で話しています。二人はいつ会いますか。女の人：もしもし、今日の約束なんだけど、急に仕事が入っちゃって。男の人：そうなんだ。じゃ、明日はどう？女の人：うん、明日なら大丈夫。じゃ、明日ね。二人はいつ会いますか。","question":"二人はいつ会いますか。","options":["今日","来週","来月","明日"],"answer":3,"type":"課題理解"},{"audio":"病院で医者が話しています。患者は何に気をつけますか。医者：検査の結果、特に問題はありませんでした。ただ、少し太り気味ですね。食事に気をつけてください。特に甘いものと油っぽいものは控えめに。患者は何に気をつけますか。","question":"患者は何に気をつけますか。","options":["運動","食事","睡眠","仕事"],"answer":1,"type":"課題理解"},{"audio":"女の人が旅行について話しています。女の人は何が一番楽しかったですか。女の人：先週、北海道に旅行に行ってきたんです。食べ物もおいしかったし、温泉も気持ちよかったんですけど、一番よかったのは景色ですね。山の上から見た景色は本当にきれいでした。女の人は何が一番楽しかったですか。","question":"女の人は何が一番楽しかったですか。","options":["食べ物","買い物","景色","温泉"],"answer":2,"type":"ポイント理解"},{"audio":"男の人が仕事について話しています。男の人は今何が大変ですか。男の人：最近、仕事がとても多くて、毎日残業しているんです。給料は悪くないし、通勤も30分だけなんですけど、仕事が多すぎて大変です。男の人は今何が大変ですか。","question":"男の人は今何が大変ですか。","options":["仕事が多い","給料が安い","通勤が長い","人間関係"],"answer":0,"type":"ポイント理解"},{"audio":"学生が自分の趣味について話しています。学生はなぜこの趣味を始めましたか。学生：私の趣味はテニスです。高校の時、友達に誘われて始めました。最初は下手でしたが、今では週に2回練習しています。学生はなぜこの趣味を始めましたか。","question":"学生はなぜこの趣味を始めましたか。","options":["健康のため","テレビで見た","友達に誘われた","親の影響"],"answer":2,"type":"ポイント理解"},{"audio":"女の人が映画について話しています。女の人はこの映画をどう思っていますか。女の人：昨日見た映画、すごくよかったですよ。ストーリーも面白いし、俳優の演技も素晴らしかったです。ぜひ見てください。女の人はこの映画をどう思っていますか。","question":"女の人はこの映画をどう思っていますか。","options":["まあまあ","とてもいい","つまらない","見ていない"],"answer":1,"type":"ポイント理解"},{"audio":"男の人が料理について話しています。男の人は何が得意ですか。男の人：私は料理が好きで、よく家で作るんです。特に和食が得意で、煮物とか味噌汁とかよく作ります。洋食や中華はあまり作らないですね。男の人は何が得意ですか。","question":"男の人は何が得意ですか。","options":["洋食","和食","中華","お菓子"],"answer":1,"type":"ポイント理解"},{"audio":"先生が授業について話しています。来週何をしますか。先生：今週の授業はここまでです。来週は今までの復習をしません。テストをします。しっかり勉強してきてください。来週何をしますか。","question":"来週何をしますか。","options":["テスト","発表","復習","遠足"],"answer":0,"type":"ポイント理解"},{"audio":"ラジオで人が話しています。この人は何について話していますか。話し手：みなさん、こんにちは。今日は健康的な生活についてお話しします。まず、毎日7時間以上寝ることが大切です。そして、野菜をたくさん食べて、適度な運動をしましょう。これで健康に過ごせますよ。この人は何について話していますか。","question":"この人は何について話していますか。","options":["健康的な生活","新しい仕事","旅行の計画","料理の方法"],"answer":0,"type":"概要理解"},{"audio":"テレビで人が話しています。この番組は何を紹介していますか。ナレーター：今日は渋谷にオープンしたばかりの新しいカフェをご紹介します。こちらのお店は、特製のパンケーキが人気で、毎日たくさんのお客様が来るそうです。場所は渋谷駅から歩いて5分です。この番組は何を紹介していますか。","question":"この番組は何を紹介していますか。","options":["観光地","映画","本","新しいお店"],"answer":3,"type":"概要理解"},{"audio":"会議で社長が話しています。社長は何を言いたいですか。社長：皆さん、お疲れ様です。今年は売り上げが下がってしまいました。来年はもっと頑張らなければなりません。一人一人が目標を持って、全力で取り組んでください。よろしくお願いします。社長は何を言いたいですか。","question":"社長は何を言いたいですか。","options":["もっと頑張れ","休みを増やす","給料を上げる","新しい人を雇う"],"answer":0,"type":"概要理解"},{"audio":"友達に本を借りたいです。何と言いますか。あなたは友達の家にいます。友達の本棚に読みたい本があります。その本を借りたいです。何と言いますか。","question":"何と言いますか。","options":["本を借りてくれない？","本を貸してくれない？","本をあげる","本をもらう"],"answer":1,"type":"発話表現"},{"audio":"電車で席を譲りたいです。何と言いますか。あなたは電車に座っています。お年寄りが乗ってきました。席を譲りたいです。何と言いますか。","question":"何と言いますか。","options":["すみません、座らせてください","どうぞ、お座りください","座っていいですか","立ってください"],"answer":1,"type":"発話表現"},{"audio":"お手伝いを申し出たいです。何と言いますか。あなたは友達の家にいます。友達がたくさんの荷物を持っています。手伝いたいです。何と言いますか。","question":"何と言いますか。","options":["何かお手伝いしましょうか","手伝ってください","手伝えません","手伝う必要はない"],"answer":0,"type":"発話表現"},{"audio":"ごちそうになりました。何と言いますか。あなたは友達の家で夕食をごちそうになりました。おいしい料理でした。食事が終わりました。何と言いますか。","question":"何と言いますか。","options":["いただきます","おいしかったです","ごちそうさまでした","また来ます"],"answer":2,"type":"発話表現"},{"audio":"お元気ですかと聞かれました。男の人：山田さん、お久しぶりです。お元気ですか。何と答えますか。","question":"何と答えますか。","options":["いいえ、結構です","そうですね","はい、おかげさまで","すみません"],"answer":2,"type":"即時応答"},{"audio":"この席、空いていますかと聞かれました。男の人：すみません、この席、空いていますか。何と答えますか。","question":"何と答えますか。","options":["いいえ、座ってください","すみません、立ってください","わかりません","はい、どうぞ"],"answer":3,"type":"即時応答"},{"audio":"週末は何をしましたかと聞かれました。女の人：週末は何をしましたか。何と答えますか。","question":"何と答えますか。","options":["映画を見ています","映画を見ます","映画を見たい","映画を見ました"],"answer":3,"type":"即時応答"},{"audio":"すみません、道を教えてくださいと言われました。女の人：すみません、駅はどこですか。何と答えますか。","question":"何と答えますか。","options":["道を聞いてください","すみません","まっすぐ行ってください","わかります"],"answer":2,"type":"即時応答"},{"audio":"コーヒーはいかがですかと聞かれました。女の人：コーヒーはいかがですか。何と答えますか。","question":"何と答えますか。","options":["はい、飲みたくないです","はい、いただきます","コーヒーを作ります","コーヒーはありません"],"answer":1,"type":"即時応答"},{"audio":"明日のパーティーに来られますかと聞かれました。男の人：明日のパーティーに来られますか。何と答えますか。","question":"何と答えますか。","options":["はい、来ません","いいえ、行きます","パーティーをします","はい、行きます"],"answer":3,"type":"即時応答"},{"audio":"お荷物、お持ちしましょうかと言われました。女の人：お荷物、お持ちしましょうか。何と答えますか。","question":"何と答えますか。","options":["荷物を持っています","荷物がありません","持ってください","ありがとうございます、お願いします"],"answer":3,"type":"即時応答"},{"audio":"この料理、おいしいですねと言われました。男の人：この料理、おいしいですね。何と答えますか。","question":"何と答えますか。","options":["そうですね、とてもおいしいです","おいしくないです","料理を作ります","食べません"],"answer":0,"type":"即時応答"},{"audio":"お先に失礼しますと言われました。同僚：お先に失礼します。何と答えますか。","question":"何と答えますか。","options":["いただきます","ただいま","お疲れさまでした","行ってきます"],"answer":2,"type":"即時応答"}]};
const LEVEL = "N3";
const TIME_LIMIT = 2400; // seconds
const PASS_SCORE = 60; // percent
const STORAGE_KEY = "fujisan_mock_v200_N3_19";

// State
let currentQ = 0;
let answers = {};
let startTime = null;
let timerInterval = null;
let isReview = false;
let questions = [];
let testResults = null;

// Init
function init() {
  loadStats();
}

function loadStats() {
  const data = getData();
  document.getElementById('stat-best').textContent = data.best !== null ? data.best + '%' : '-%';
  document.getElementById('stat-attempts').textContent = data.attempts || 0;
  document.getElementById('stat-wrong').textContent = (data.wrongQuestions || []).length;
}

function getData() {
  const saved = localStorage.getItem(STORAGE_KEY);
  return saved ? JSON.parse(saved) : { best: null, attempts: 0, wrongQuestions: [] };
}

function saveData(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

// Start Test
function startTest() {
  currentQ = 0;
  answers = {};
  isReview = false;
  questions = [...TEST.questions];
  testResults = null;
  
  showScreen('test');
  document.getElementById('test-title').textContent = TEST.title;
  
  startTime = Date.now();
  updateTimer();
  timerInterval = setInterval(updateTimer, 1000);
  
  renderQuestion();
}

function startReview() {
  const data = getData();
  if (!data.wrongQuestions || data.wrongQuestions.length === 0) {
    alert('復習する問題がありません！');
    return;
  }
  
  currentQ = 0;
  answers = {};
  isReview = true;
  questions = data.wrongQuestions.map((q, i) => ({...q, originalIndex: q.index}));
  testResults = null;
  
  showScreen('test');
  document.getElementById('test-title').textContent = '📚 復習モード';
  document.getElementById('timer').textContent = '復習中';
  
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = null;
  
  renderQuestion();
}

// Timer
function updateTimer() {
  const elapsed = Math.floor((Date.now() - startTime) / 1000);
  const remaining = TIME_LIMIT - elapsed;
  
  const timerEl = document.getElementById('timer');
  
  if (remaining <= 0) {
    clearInterval(timerInterval);
    timerEl.textContent = '00:00';
    timerEl.classList.add('danger');
    submitTest();
    return;
  }
  
  const mins = Math.floor(remaining / 60);
  const secs = remaining % 60;
  timerEl.textContent = String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
  
  timerEl.classList.remove('warning', 'danger');
  if (remaining <= 60) {
    timerEl.classList.add('danger');
  } else if (remaining <= 180) {
    timerEl.classList.add('warning');
  }
}

// Render Question
function renderQuestion() {
  const q = questions[currentQ];
  const container = document.getElementById('question-container');
  
  // Progress
  document.getElementById('progress-fill').style.width = ((currentQ + 1) / questions.length * 100) + '%';
  document.getElementById('progress-text').textContent = (currentQ + 1) + ' / ' + questions.length;
  
  // Navigation buttons
  document.getElementById('btn-prev').disabled = currentQ === 0;
  document.getElementById('btn-next').disabled = currentQ === questions.length - 1;
  
  // Question
  let html = '<div class="section-badge">' + (q.section || '問題') + '</div>';
  
  // Audio button for listening
  if (q.audio) {
    html += '<button class="audio-btn" id="audio-btn" onclick="playAudio()">🔊 音声を再生</button>';
  }
  
  html += '<div class="question-text">' + q.text + '</div>';
  html += '<div class="options">';
  
  q.options.forEach((opt, i) => {
    const selected = answers[currentQ] === i ? 'selected' : '';
    html += '<div class="option ' + selected + '" onclick="selectAnswer(' + i + ')">';
    html += '<span class="option-label">' + (i + 1) + '</span>';
    html += '<span class="option-text">' + opt + '</span>';
    html += '</div>';
  });
  
  html += '</div>';
  container.innerHTML = html;
}

function selectAnswer(index) {
  answers[currentQ] = index;
  renderQuestion();
}

function prevQ() {
  if (currentQ > 0) {
    currentQ--;
    renderQuestion();
  }
}

function nextQ() {
  if (currentQ < questions.length - 1) {
    currentQ++;
    renderQuestion();
  }
}

// Audio
let isPlaying = false;
function playAudio() {
  if (isPlaying) return;
  const q = questions[currentQ];
  if (!q.audio) return;
  
  const btn = document.getElementById('audio-btn');
  btn.disabled = true;
  btn.classList.add('playing');
  btn.textContent = '🔊 再生中...';
  isPlaying = true;
  
  speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(q.audio);
  utterance.lang = 'ja-JP';
  utterance.rate = 0.9;
  
  utterance.onend = () => {
    btn.disabled = false;
    btn.classList.remove('playing');
    btn.textContent = '🔊 もう一度再生';
    isPlaying = false;
  };
  
  utterance.onerror = () => {
    btn.disabled = false;
    btn.classList.remove('playing');
    btn.textContent = '🔊 音声を再生';
    isPlaying = false;
  };
  
  speechSynthesis.speak(utterance);
}

// Submit Test
function submitTest() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
  
  // Calculate results
  let correct = 0;
  const wrongQuestions = [];
  const sectionScores = {};
  
  questions.forEach((q, i) => {
    const section = q.section || '問題';
    if (!sectionScores[section]) {
      sectionScores[section] = { correct: 0, total: 0 };
    }
    sectionScores[section].total++;
    
    if (answers[i] === q.answer) {
      correct++;
      sectionScores[section].correct++;
    } else {
      wrongQuestions.push({
        ...q,
        index: q.originalIndex !== undefined ? q.originalIndex : i,
        userAnswer: answers[i]
      });
    }
  });
  
  const score = Math.round((correct / questions.length) * 100);
  const passed = score >= PASS_SCORE;
  
  testResults = {
    score,
    correct,
    total: questions.length,
    passed,
    sectionScores,
    wrongQuestions,
    answers: {...answers}
  };
  
  // Save data (not in review mode)
  if (!isReview) {
    const data = getData();
    data.attempts = (data.attempts || 0) + 1;
    if (data.best === null || score > data.best) {
      data.best = score;
    }
    // Update wrong questions list
    const existingWrong = data.wrongQuestions || [];
    wrongQuestions.forEach(wq => {
      if (!existingWrong.find(e => e.text === wq.text)) {
        existingWrong.push(wq);
      }
    });
    // Remove questions that were answered correctly
    data.wrongQuestions = existingWrong.filter(wq => {
      const idx = questions.findIndex(q => q.text === wq.text);
      return idx === -1 || answers[idx] !== wq.answer;
    });
    saveData(data);
  }
  
  // Show results
  showResults();
}

function showResults() {
  showScreen('results');
  
  const { score, correct, total, passed, sectionScores, wrongQuestions } = testResults;
  
  document.getElementById('score-value').textContent = score + '%';
  document.getElementById('score-detail').textContent = correct + '問正解 / ' + total + '問中';
  
  const passBadge = document.getElementById('pass-badge');
  passBadge.textContent = passed ? '合格ライン到達！' : '不合格';
  passBadge.className = 'pass-badge ' + (passed ? 'pass' : 'fail');
  
  // Section scores
  let sectionsHtml = '';
  Object.entries(sectionScores).forEach(([section, scores]) => {
    const pct = Math.round((scores.correct / scores.total) * 100);
    sectionsHtml += '<div class="section-score-card">';
    sectionsHtml += '<div class="section-score-value">' + scores.correct + '/' + scores.total + '</div>';
    sectionsHtml += '<div class="section-score-label">' + section.substring(0, 8) + '</div>';
    sectionsHtml += '</div>';
  });
  document.getElementById('section-scores').innerHTML = sectionsHtml;
  
  // Answer list
  renderAnswerList();
  
  loadStats();
}

function renderAnswerList() {
  const { answers: testAnswers } = testResults;
  let html = '';
  
  questions.forEach((q, i) => {
    const isCorrect = testAnswers[i] === q.answer;
    const userAns = testAnswers[i] !== undefined ? q.options[testAnswers[i]] : '未回答';
    const correctAns = q.options[q.answer];
    
    html += '<div class="answer-item ' + (isCorrect ? '' : 'wrong') + '">';
    html += '<div class="answer-q-num">問' + (i + 1) + ' - ' + (q.section || '問題') + '</div>';
    html += '<div class="answer-q-text">' + q.text.substring(0, 100) + (q.text.length > 100 ? '...' : '') + '</div>';
    html += '<div class="answer-result">';
    if (isCorrect) {
      html += '<div class="answer-correct">✓ 正解: ' + correctAns + '</div>';
    } else {
      html += '<div class="answer-your">✗ あなたの回答: ' + userAns + '</div>';
      html += '<div class="answer-correct">○ 正解: ' + correctAns + '</div>';
    }
    html += '</div></div>';
  });
  
  document.getElementById('answer-list').innerHTML = html;
}

function toggleAnswerList() {
  const list = document.getElementById('answer-list');
  const btn = document.getElementById('review-toggle');
  
  if (list.classList.contains('hidden')) {
    list.classList.remove('hidden');
    btn.textContent = '📋 正誤一覧を隠す';
  } else {
    list.classList.add('hidden');
    btn.textContent = '📋 正誤一覧を表示';
  }
}

function reviewWrong() {
  if (!testResults || testResults.wrongQuestions.length === 0) {
    alert('間違えた問題がありません！');
    return;
  }
  
  currentQ = 0;
  answers = {};
  isReview = true;
  questions = testResults.wrongQuestions.map((q, i) => ({...q}));
  testResults = null;
  
  showScreen('test');
  document.getElementById('test-title').textContent = '❌ 間違えた問題';
  document.getElementById('timer').textContent = '復習中';
  
  renderQuestion();
}

// Navigation
function showScreen(id) {
  ['home', 'test', 'results'].forEach(s => {
    document.getElementById(s).classList.toggle('hidden', s !== id);
  });
}

function goHome() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
  showScreen('home');
  loadStats();
}

function resetData() {
  if (confirm('このテストのすべてのデータをリセットしますか？')) {
    localStorage.removeItem(STORAGE_KEY);
    loadStats();
    alert('リセットしました');
  }
}

// Initialize
init();
</script>
</body>
</html>
